<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç»¿è‰²èƒ½æºè´§ç‰©äº¤ä»˜ç³»ç»Ÿ (ç™¾åº¦ OCR ç‰ˆ)</title>
    <style>
        :root { --primary: #2c7be5; --success: #00d97e; --warning: #f6c343; --danger: #e63757; --bg: #f5f7fb; --card: #fff; --text: #12263f; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; }
        body { background: var(--bg); color: var(--text); padding-bottom: 70px; }
        .nav { position: fixed; bottom: 0; width: 100%; background: var(--card); display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 999; }
        .nav-item { text-align: center; font-size: 12px; color: #6e84a3; flex: 1; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-icon { font-size: 20px; display: block; margin-bottom: 2px; }
        .page { display: none; padding: 15px; animation: fade 0.3s; }
        .page.active { display: block; }
        @keyframes fade { from { opacity: 0; } to { opacity: 1; } }
        h1 { font-size: 22px; margin-bottom: 15px; color: var(--text); }
        h3 { font-size: 18px; margin: 15px 0 10px; border-left: 4px solid var(--primary); padding-left: 10px; }
        .card { background: var(--card); border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .form-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #d9e2ef; border-radius: 6px; font-size: 16px; }
        input:focus { border-color: var(--primary); outline: none; }
        .btn { width: 100%; padding: 12px; background: var(--primary); color: #fff; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn:active { opacity: 0.9; }
        .btn-success { background: var(--success); }
        .btn-warning { background: var(--warning); color: #333; }
        .btn-danger { background: var(--danger); }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .upload-box { border: 2px dashed #d9e2ef; padding: 20px; text-align: center; border-radius: 8px; background: #fafbfc; cursor: pointer; }
        #preview { max-width: 100%; margin-top: 10px; border-radius: 6px; display: none; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 10px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .progress { width: 100%; height: 6px; background: #eee; border-radius: 3px; margin: 10px 0; display: none; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.2s; }
        .status-text { font-size: 12px; color: #666; text-align: center; margin-top: 5px; display: none; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #666; }
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: #fff; padding: 10px 20px; border-radius: 20px; font-size: 14px; z-index: 1000; display: none; }
        .debug-box { background: #f8f9fa; border: 1px solid #ddd; border-radius: 6px; padding: 10px; margin-top: 10px; font-size: 12px; max-height: 200px; overflow-y: auto; white-space: pre-wrap; display: none; }
        .debug-title { font-weight: bold; margin-bottom: 5px; color: #666; }
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; margin-bottom: 10px; }
        .status-ok { background: #d4edda; color: #155724; }
        .status-err { background: #f8d7da; color: #721c24; }
        .status-warn { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>


    <div id="page-home" class="page active">
        <h1>ğŸ“¸ è¿‡ç£…å•è¯†åˆ« (ç™¾åº¦é«˜ç²¾åº¦)</h1>
        
        <div class="card">
            <div id="apiStatus" class="status-badge status-warn">ğŸ”„ æ­£åœ¨è¿æ¥ç™¾åº¦ OCR...</div>
            
            <div class="upload-box" onclick="document.getElementById('fileInput').click()">
                <p>ğŸ“· ç‚¹å‡»æ‹ç…§æˆ–é€‰æ‹©å›¾ç‰‡</p>
                <input type="file" id="fileInput" accept="image/*" capture="environment" style="display:none" onchange="handleFile(event)">
            </div>
            <img id="preview" alt="é¢„è§ˆ">
            
            <div id="loader" class="loader"></div>
            <div id="progress" class="progress"><div id="pBar" class="progress-bar"></div></div>
            <div id="statusText" class="status-text">å‡†å¤‡å°±ç»ª</div>


            <button id="btnRec" class="btn btn-success" style="display:none" onclick="startOCR()">ğŸš€ å¼€å§‹ç™¾åº¦ OCR è¯†åˆ«</button>
            <button class="btn btn-warning" onclick="enableManual()">âœï¸ æ‰‹åŠ¨è¾“å…¥</button>
            
            <div id="debugBox" class="debug-box">
                <div class="debug-title">ğŸ“‹ è¯†åˆ«ç»“æœï¼š</div>
                <div id="debugText"></div>
            </div>
        </div>


        <div id="formArea" class="card" style="display:none">
            <h3>ğŸ“ æ•°æ®æ ¸å¯¹</h3>
            <div class="form-group"><label>ä¾›åº”å•†</label><input type="text" id="f_supplier" value="å®‰ä¹¡å¿é¡ºæ¸…ç§¸ç§†ç»¼åˆåˆ©ç”¨ä¸“ä¸šåˆä½œç¤¾"></div>
            <div class="form-group"><label>è½¦ç‰Œå·</label><input type="text" id="f_plate" placeholder="æ¹˜J..."></div>
            <div class="form-group"><label>ç‡ƒæ–™ç§ç±»</label>
                <select id="f_fuel">
                    <option value="ææ¡ æŸ´ä¸‰çº§">ææ¡ æŸ´ä¸‰çº§</option>
                    <option value="æ¨æ ‘çš®ä¸€çº§">æ¨æ ‘çš®ä¸€çº§</option>
                    <option value="æ¨æ ‘çš®äºŒçº§">æ¨æ ‘çš®äºŒçº§</option>
                    <option value="æ‰æœ¨æ ‘æä¸€çº§">æ‰æœ¨æ ‘æä¸€çº§</option>
                    <option value="æ‰æœ¨æ ‘æäºŒçº§">æ‰æœ¨æ ‘æäºŒçº§</option>
                    <option value="å¹²æ ‘æä¸€çº§">å¹²æ ‘æä¸€çº§</option>
                    <option value="å¹²æ ‘æäºŒçº§">å¹²æ ‘æäºŒçº§</option>
                    <option value="å¸¦å¶è–ªæŸ´ä¸‰çº§">å¸¦å¶è–ªæŸ´ä¸‰çº§</option>
                    <option value="ç«¹æ">ç«¹æ</option>
                </select>
            </div>
            <div class="form-group"><label>æ—¥æœŸ</label><input type="date" id="f_date"></div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div class="form-group"><label>æ¯›é‡</label><input type="number" step="0.01" id="f_gross" oninput="calc()"></div>
                <div class="form-group"><label>çš®é‡</label><input type="number" step="0.01" id="f_tare" oninput="calc()"></div>
                <div class="form-group"><label>å‡€é‡</label><input type="number" step="0.01" id="f_net" oninput="calc()"></div>
                <div class="form-group"><label>ç»“ç®—å‡€é‡</label><input type="number" step="0.01" id="f_final" readonly style="background:#eee"></div>
            </div>


            <div class="form-group"><label>æ‰£æ‚åˆè®¡ (%)</label><input type="number" step="0.01" id="f_deduct" value="0" oninput="calc()"></div>
            
            <button class="btn btn-success" onclick="saveData()">âœ… ç¡®è®¤ä¿å­˜</button>
        </div>
    </div>


    <div id="page-data" class="page">
        <h1>ğŸ“Š å†å²è®°å½•</h1>
        <div class="card">
            <input type="text" id="search" placeholder="æœç´¢è½¦ç‰Œ/æ—¥æœŸ..." onkeyup="renderList()" style="margin-bottom:10px">
            <div style="overflow-x:auto">
                <table id="tbl">
                    <thead><tr><th>æ—¥æœŸ</th><th>è½¦ç‰Œ</th><th>å‡€é‡</th><th>æ€»é¢</th><th>æ“ä½œ</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <button class="btn btn-outline" onclick="exportData()">ğŸ“¥ å¯¼å‡ºè¡¨æ ¼</button>
        <button class="btn btn-danger" style="margin-top:10px" onclick="clearData()">ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®</button>
    </div>


    <div id="page-price" class="page">
        <h1>ğŸ’° ä»·æ ¼ç®¡ç†</h1>
        <div class="card" id="priceBox"></div>
        <button class="btn btn-success" onclick="savePrice()">ğŸ’¾ ä¿å­˜ä»·æ ¼</button>
    </div>


    <div id="page-about" class="page">
        <h1>â„¹ï¸ ç³»ç»Ÿä¿¡æ¯</h1>
        <div class="card">
            <p><strong>ç‰ˆæœ¬ï¼š</strong>v4.0 ç™¾åº¦ OCR ç‰ˆ</p>
            <p><strong>è¯†åˆ«å¼•æ“ï¼š</strong>ç™¾åº¦æ™ºèƒ½äº‘ é€šç”¨æ–‡å­—è¯†åˆ«ï¼ˆé«˜ç²¾åº¦ç‰ˆï¼‰</p>
            <p><strong>AppIDï¼š</strong>122102244</p>
            <p><strong>æ•°æ®å­˜å‚¨ï¼š</strong>æ‰‹æœºæœ¬åœ°å­˜å‚¨</p>
            <p style="color:green; margin-top:10px">âœ… é«˜ç²¾åº¦è¯†åˆ«ï¼Œå‡†ç¡®ç‡ 98%+</p>
        </div>
    </div>


    <div class="nav">
        <div class="nav-item active" onclick="sw('home',this)"><span class="nav-icon">ğŸ </span>é¦–é¡µ</div>
        <div class="nav-item" onclick="sw('data',this)"><span class="nav-icon">ğŸ“‚</span>è®°å½•</div>
        <div class="nav-item" onclick="sw('price',this)"><span class="nav-icon">ğŸ’²</span>ä»·æ ¼</div>
        <div class="nav-item" onclick="sw('about',this)"><span class="nav-icon">â„¹ï¸</span>å…³äº</div>
    </div>


    <div id="toast" class="toast">æç¤º</div>


    <script>
        // ============ ç™¾åº¦ OCR é…ç½® ============
        const BAIDU = {
            appId: '122102244',
            apiKey: 'NnrvJeOWeVcQ4vEdOWcT20q7',
            secretKey: 'WuIokhwPmDXPgS1Viz8m1jaIaM7dlsUY'
        };


        // CORS ä»£ç†åˆ—è¡¨ (å¤šä¸ªå¤‡ç”¨)
        const PROXIES = [
            'https://baidu-ocr-proxy.luzer244.workers.dev/?url='
        ];


        // ä»·æ ¼å’Œæ•°æ®
        let prices = JSON.parse(localStorage.getItem('prices')) || [
            {n:"ææ¡ æŸ´ä¸‰çº§", p:202}, {n:"æ¨æ ‘çš®ä¸€çº§", p:180}, {n:"æ¨æ ‘çš®äºŒçº§", p:247},
            {n:"æ‰æœ¨æ ‘æä¸€çº§", p:202}, {n:"æ‰æœ¨æ ‘æäºŒçº§", p:242}, {n:"å¹²æ ‘æä¸€çº§", p:298},
            {n:"å¹²æ ‘æäºŒçº§", p:240}, {n:"å¸¦å¶è–ªæŸ´ä¸‰çº§", p:270}, {n:"ç«¹æ", p:222}
        ];
        let records = JSON.parse(localStorage.getItem('records')) || [];
        let curImg = null;
        let curImgBase64 = null;
        let accessToken = '';
        let tokenExpire = 0;


        window.onload = () => {
            document.getElementById('f_date').valueAsDate = new Date();
            renderPrice();
            renderList();
            initBaiduOCR();
        };


        function sw(id, el) {
            document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
            document.getElementById('page-'+id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
            if(el) el.classList.add('active');
            if(id==='data') renderList();
            if(id==='price') renderPrice();
        }


        function toast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.display='block';
            setTimeout(()=>t.style.display='none', 2000);
        }


        // ============ ç™¾åº¦ OCR åˆå§‹åŒ– ============
        async function initBaiduOCR() {
            const statusEl = document.getElementById('apiStatus');
            try {
                await getAccessToken();
                statusEl.className = 'status-badge status-ok';
                statusEl.innerText = 'âœ… ç™¾åº¦ OCR å·²å°±ç»ª';
            } catch(err) {
                statusEl.className = 'status-badge status-err';
                statusEl.innerText = 'âŒ ç™¾åº¦ OCR è¿æ¥å¤±è´¥';
                console.error('åˆå§‹åŒ–å¤±è´¥:', err);
            }
        }


        async function getAccessToken() {
            // æ£€æŸ¥ç¼“å­˜
            if(accessToken && Date.now() < tokenExpire) {
                return accessToken;
            }


            const url = `https://aip.baidubce.com/oauth/2.0/token?grant_type=client_credentials&client_id=${BAIDU.apiKey}&client_secret=${BAIDU.secretKey}`;
            
            // å°è¯•å¤šä¸ªä»£ç†
            for(const proxy of PROXIES) {
                try {
                    const res = await fetch(proxy + encodeURIComponent(url));
                    if(!res.ok) continue;
                    const data = await res.json();
                    if(data.access_token) {
                        accessToken = data.access_token;
                        tokenExpire = Date.now() + (29 * 24 * 60 * 60 * 1000); // 29 å¤©
                        console.log('è·å– Token æˆåŠŸ');
                        return accessToken;
                    }
                } catch(e) {
                    console.log('ä»£ç†å¤±è´¥:', proxy, e.message);
                    continue;
                }
            }
            throw new Error('æ‰€æœ‰ä»£ç†å‡å¤±è´¥');
        }


        // ============ å›¾ç‰‡å¤„ç† ============
        function handleFile(e) {
            const f = e.target.files[0];
            if(!f) return;
            curImg = f;
            const r = new FileReader();
            r.onload = (ev) => {
                const img = document.getElementById('preview');
                img.src = ev.target.result;
                img.style.display = 'block';
                document.getElementById('btnRec').style.display = 'block';
                document.getElementById('debugBox').style.display = 'none';
                // æå– base64 (å»æ‰ data:image/jpeg;base64, å‰ç¼€)
                curImgBase64 = ev.target.result.split(',')[1];
            };
            r.readAsDataURL(f);
        }


        // ============ å¼€å§‹ OCR è¯†åˆ« ============
        async function startOCR() {
            if(!curImgBase64) return alert('è¯·å…ˆé€‰æ‹©å›¾ç‰‡');
            
            const btn = document.getElementById('btnRec');
            const loader = document.getElementById('loader');
            const progress = document.getElementById('progress');
            const pBar = document.getElementById('pBar');
            const statusText = document.getElementById('statusText');
            const debugBox = document.getElementById('debugBox');
            const debugText = document.getElementById('debugText');


            btn.disabled = true;
            loader.style.display = 'block';
            progress.style.display = 'block';
            debugBox.style.display = 'block';
            pBar.style.width = '20%';
            statusText.innerText = 'æ­£åœ¨è·å–è®¤è¯...';
            debugText.innerText = 'æ­£åœ¨è¿æ¥ç™¾åº¦ OCR æœåŠ¡...';


            try {
                // 1. è·å– Token
                await getAccessToken();
                pBar.style.width = '40%';
                statusText.innerText = 'æ­£åœ¨è¯†åˆ«å›¾ç‰‡...';


                // 2. è°ƒç”¨ OCR æ¥å£
                const ocrUrl = `https://aip.baidubce.com/rest/2.0/ocr/v1/accurate_basic?access_token=${accessToken}`;
                let ocrResult = null;


                for(const proxy of PROXIES) {
                    try {
                        statusText.innerText = `å°è¯•ä»£ç†ï¼š${proxy.substring(0, 30)}...`;
                        const res = await fetch(proxy + encodeURIComponent(ocrUrl), {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                            body: `image=${encodeURIComponent(curImgBase64)}`
                        });


                        if(!res.ok) {
                            console.log('ä»£ç†è¿”å›çŠ¶æ€:', res.status);
                            continue;
                        }


                        const data = await res.json();
                        if(data.error_code) {
                            throw new Error(data.error_msg || 'è¯†åˆ«å¤±è´¥');
                        }


                        ocrResult = data;
                        break;
                    } catch(e) {
                        console.log('ä»£ç†å¤±è´¥:', proxy, e.message);
                        continue;
                    }
                }


                if(!ocrResult) {
                    throw new Error('æ‰€æœ‰ä»£ç†å‡æ— æ³•å®Œæˆè¯†åˆ«ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åé‡è¯•');
                }


                pBar.style.width = '100%';
                statusText.innerText = 'è¯†åˆ«å®Œæˆï¼';
                debugText.innerText = JSON.stringify(ocrResult.words_result, null, 2);


                // 3. è§£æç»“æœ
                parseOCRResult(ocrResult.words_result);
                document.getElementById('formArea').style.display = 'block';
                toast('âœ… è¯†åˆ«æˆåŠŸï¼Œè¯·æ ¸å¯¹æ•°æ®');


            } catch(err) {
                console.error(err);
                statusText.innerText = 'è¯†åˆ«å¤±è´¥';
                debugText.innerText = 'é”™è¯¯ï¼š' + err.message;
                alert('è¯†åˆ«å¤±è´¥ï¼š' + err.message + '\n\nå»ºè®®ï¼š\n1. æ£€æŸ¥ç½‘ç»œè¿æ¥\n2. ç¨åé‡è¯•\n3. ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥');
                enableManual();
            } finally {
                btn.disabled = false;
                loader.style.display = 'none';
                progress.style.display = 'none';
                statusText.style.display = 'none';
            }
        }


        // ============ è§£æ OCR ç»“æœï¼ˆä¿®å¤ç‰ˆï¼‰ ============
function parseOCRResult(wordsList) {
    console.log('è¯†åˆ«ç»“æœ:', wordsList);
    
    let d = { 
        plate: '', 
        net: '', 
        gross: '', 
        tare: '', 
        fuel: '', 
        date: '', 
        supplier: '',
        deduct: 0
    };
    
    wordsList.forEach(item => {
        const text = item.words.trim();
        console.log('å¤„ç†:', text);

        // 1. ä¾›åº”å•† - å»æ‰"ä¾›åº”å•†ï¼š"å‰ç¼€
        if(text.includes('ä¾›åº”å•†')) {
            d.supplier = text.replace(/.*?ä¾›åº”å•† [:ï¼š]?\s*/, '').trim();
            console.log('åŒ¹é…åˆ°ä¾›åº”å•†:', d.supplier);
        }

        // 2. è½¦ç‰Œå· - ä¸“é—¨åŒ¹é… æ¹˜ J+ æ•°å­—å­—æ¯
        if(text.includes('è½¦ç‰Œ') || text.match(/æ¹˜ [A-Z0-9]+/)) {
            const m = text.match(/æ¹˜ [A-Z0-9]{5,}/);
            if(m) {
                d.plate = m[0];
                console.log('åŒ¹é…åˆ°è½¦ç‰Œ:', d.plate);
            }
        }

        // 3. ç‡ƒæ–™ç§ç±»
        if(text.includes('ç‡ƒæ–™ç§ç±»') || text.includes('ææ¡ ') || text.includes('æ¨æ ‘') || text.includes('æ‰æœ¨') || text.includes('æ ‘æ') || text.includes('è–ªæŸ´') || text.includes('ç«¹æ')) {
            const fuels = ['ææ¡ æŸ´ä¸‰çº§', 'æ¨æ ‘çš®ä¸€çº§', 'æ¨æ ‘çš®äºŒçº§', 'æ‰æœ¨æ ‘æä¸€çº§', 'æ‰æœ¨æ ‘æäºŒçº§', 'å¹²æ ‘æä¸€çº§', 'å¹²æ ‘æäºŒçº§', 'å¸¦å¶è–ªæŸ´ä¸‰çº§', 'ç«¹æ'];
            for(const f of fuels) {
                if(text.includes(f)) {
                    d.fuel = f;
                    console.log('åŒ¹é…åˆ°ç‡ƒæ–™:', d.fuel);
                    break;
                }
            }
        }

        // 4. æ—¥æœŸ - æ”¯æŒå¤šç§æ ¼å¼ (YYYY/MM/DD æˆ– YYYY-MM-DD)
        if(text.includes('å•å·') || text.match(/\d{4}[-/]\d{2}[-/]\d{2}/)) {
            // å…ˆå°è¯•ä»å•å·æå–
            let m = text.match(/(\d{4})[-/](\d{2})[-/](\d{2})/);
            if(!m) {
                // å†å°è¯•ä»å…¶ä»–ä½ç½®æå–æ—¥æœŸ
                m = text.match(/(\d{4})(\d{2})(\d{2})/);
            }
            if(m) {
                // ç»Ÿä¸€è½¬æ¢ä¸º YYYY-MM-DD æ ¼å¼
                d.date = `${m[1]}-${m[2]}-${m[3]}`;
                console.log('åŒ¹é…åˆ°æ—¥æœŸ:', d.date);
            }
        }

        // 5. æ¯›é‡ - æå–æœ€åä¸€ä¸ªæ•°å­—
        if(text.includes('æ¯›é‡')) {
            const nums = text.match(/(\d+\.?\d*)/g);
            if(nums && nums.length > 0) {
                d.gross = parseFloat(nums[nums.length-1]);
                console.log('åŒ¹é…åˆ°æ¯›é‡:', d.gross);
            }
        }

        // 6. çš®é‡
        if(text.includes('çš®é‡')) {
            const nums = text.match(/(\d+\.?\d*)/g);
            if(nums && nums.length > 0) {
                d.tare = parseFloat(nums[nums.length-1]);
                console.log('åŒ¹é…åˆ°çš®é‡:', d.tare);
            }
        }

        // 7. å‡€é‡
        if(text.includes('å‡€é‡')) {
            const nums = text.match(/(\d+\.?\d*)/g);
            if(nums && nums.length > 0) {
                d.net = parseFloat(nums[nums.length-1]);
                console.log('åŒ¹é…åˆ°å‡€é‡:', d.net);
            }
        }

        // 8. æ‰£æ‚è´¨ - æå–ç™¾åˆ†æ¯”æ•°å€¼
        if(text.includes('æ‚è´¨') || text.includes('æ‰£æ‚è´¨')) {
            const nums = text.match(/(\d+\.?\d*)/g);
            if(nums && nums.length > 0) {
                d.deduct += parseFloat(nums[nums.length-1]);
                console.log('åŒ¹é…åˆ°æ‚è´¨:', nums[nums.length-1]);
            }
        }
        
        // 9. æ‰£éœ‰è…
        if(text.includes('éœ‰è…') || text.includes('æ‰£éœ‰è…')) {
            const nums = text.match(/(\d+\.?\d*)/g);
            if(nums && nums.length > 0) {
                d.deduct += parseFloat(nums[nums.length-1]);
                console.log('åŒ¹é…åˆ°éœ‰è…:', nums[nums.length-1]);
            }
        }
        
        // 10. æ‰£é•¿æ†
        if(text.includes('é•¿æ†') || text.includes('æ‰£é•¿æ†')) {
            const nums = text.match(/(\d+\.?\d*)/g);
            if(nums && nums.length > 0) {
                d.deduct += parseFloat(nums[nums.length-1]);
                console.log('åŒ¹é…åˆ°é•¿æ†:', nums[nums.length-1]);
            }
        }
    });

    // å¡«å……è¡¨å•
    if(d.supplier) document.getElementById('f_supplier').value = d.supplier;
    if(d.plate) document.getElementById('f_plate').value = d.plate;
    if(d.fuel) document.getElementById('f_fuel').value = d.fuel;
    if(d.date) document.getElementById('f_date').value = d.date;
    if(d.gross) document.getElementById('f_gross').value = d.gross.toFixed(2);
    if(d.tare) document.getElementById('f_tare').value = d.tare.toFixed(2);
    if(d.net) document.getElementById('f_net').value = d.net.toFixed(2);
    if(d.deduct > 0) document.getElementById('f_deduct').value = d.deduct.toFixed(2);
    
    // è‡ªåŠ¨è®¡ç®—ç»“ç®—å‡€é‡
    calc();
    
    console.log('æœ€ç»ˆè§£æç»“æœ:', d);
}


        function enableManual() {
            document.getElementById('formArea').style.display = 'block';
            document.getElementById('debugBox').style.display = 'block';
        }


        function calc() {
            const net = parseFloat(document.getElementById('f_net').value) || 0;
            const ded = parseFloat(document.getElementById('f_deduct').value) || 0;
            const final = net * (1 - ded/100);
            document.getElementById('f_final').value = final.toFixed(2);
        }


        function saveData() {
            const plate = document.getElementById('f_plate').value;
            const fuel = document.getElementById('f_fuel').value;
            const finalNet = parseFloat(document.getElementById('f_final').value);
            if(!plate || !finalNet) return alert('è¯·å¡«å†™å®Œæ•´æ•°æ®');


            const priceObj = prices.find(x=>x.n===fuel) || {p:0};
            const unitPrice = parseFloat(prompt(`è¾“å…¥å•ä»· (é»˜è®¤${priceObj.p}):`, priceObj.p));
            if(isNaN(unitPrice)) return;


            const isZheng = confirm("æ˜¯éƒ‘è€æ¿çš„è´§å—ï¼Ÿ\n(æ˜¯ï¼šæ‰£é™¤ 50 å…ƒ/å¨ è¿è´¹)");
            
            let total = finalNet * unitPrice;
            let freight = 0;
            let detail = `æ­£å¸¸ç»“ç®—`;
            
            if(isZheng) {
                const rawNet = parseFloat(document.getElementById('f_net').value) || 0;
                freight = rawNet * 50;
                total -= freight;
                detail = `æ‰£é™¤è¿è´¹ ${freight.toFixed(2)}å…ƒ`;
            }


            const rec = {
                date: document.getElementById('f_date').value,
                plate, fuel, net: finalNet, total, detail, time: Date.now()
            };
            records.unshift(rec);
            localStorage.setItem('records', JSON.stringify(records));
            
            toast('ä¿å­˜æˆåŠŸ');
            document.getElementById('formArea').style.display = 'none';
            document.getElementById('preview').style.display = 'none';
            document.getElementById('btnRec').style.display = 'none';
            document.querySelector('.upload-box').style.display = 'block';
            document.getElementById('f_plate').value = '';
            document.getElementById('f_net').value = '';
            sw('data', document.querySelectorAll('.nav-item')[1]);
        }


        function renderList() {
            const key = document.getElementById('search').value.toLowerCase();
            const tbody = document.querySelector('#tbl tbody');
            tbody.innerHTML = '';
            records.filter(r => r.plate.toLowerCase().includes(key) || r.date.includes(key)).forEach(r => {
                const tr = `<tr>
                    <td>${r.date}</td>
                    <td>${r.plate}</td>
                    <td>${r.net.toFixed(2)}</td>
                    <td style="color:${r.total<0?'red':'green'}">Â¥${r.total.toFixed(2)}</td>
                    <td><button onclick="alert('${r.detail}\næ€»é¢ï¼š${r.total.toFixed(2)}')" style="border:none;background:none;color:blue">è¯¦æƒ…</button></td>
                </tr>`;
                tbody.innerHTML += tr;
            });
        }


        function exportData() {
            if(!records.length) return alert('æ— æ•°æ®');
            let csv = "æ—¥æœŸï¼Œè½¦ç‰Œï¼Œç‡ƒæ–™ï¼Œå‡€é‡ï¼Œæ€»é¢ï¼Œå¤‡æ³¨\n";
            records.forEach(r => csv += `${r.date},${r.plate},${r.fuel},${r.net},${r.total},${r.detail}\n`);
            const blob = new Blob(["\ufeff"+csv], {type:'text/csv'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `æ•°æ®_${new Date().toLocaleDateString()}.csv`;
            a.click();
        }


        function clearData() {
            if(confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿ')) {
                records = [];
                localStorage.removeItem('records');
                renderList();
                toast('å·²æ¸…ç©º');
            }
        }


        function renderPrice() {
            const box = document.getElementById('priceBox');
            box.innerHTML = '';
            prices.forEach((item, i) => {
                box.innerHTML += `
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px">
                        <span>${item.n}</span>
                        <input type="number" value="${item.p}" data-i="${i}" style="width:80px;padding:4px">
                    </div>
                `;
            });
        }


        function savePrice() {
            const inputs = document.querySelectorAll('#priceBox input');
            inputs.forEach(inp => {
                prices[inp.dataset.i].p = parseFloat(inp.value);
            });
            localStorage.setItem('prices', JSON.stringify(prices));
            toast('ä»·æ ¼å·²æ›´æ–°');
        }
    </script>
</body>
</html>


