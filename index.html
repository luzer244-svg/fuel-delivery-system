<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç»¿è‰²èƒ½æºè´§ç‰©äº¤ä»˜ç³»ç»Ÿ</title>
    <style>
        :root {
            --primary-color: #2c7be5;
            --success-color: #00d97e;
            --warning-color: #f6c343;
            --danger-color: #e63757;
            --bg-color: #f5f7fb;
            --card-bg: #ffffff;
            --text-main: #12263f;
            --text-secondary: #6e84a3;
            --border-color: #edf2f9;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        
        body { background-color: var(--bg-color); color: var(--text-main); line-height: 1.6; padding-bottom: 80px; }
        
        .navbar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--card-bg);
            display: flex; justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            z-index: 1000;
        }
        .nav-item {
            text-align: center; font-size: 12px; color: var(--text-secondary);
            cursor: pointer; flex: 1;
        }
        .nav-item.active { color: var(--primary-color); font-weight: bold; }
        .nav-icon { font-size: 24px; display: block; margin-bottom: 2px; }

        .page { display: none; padding: 20px; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        h1, h2 { margin-bottom: 20px; color: var(--text-main); font-size: 24px; }
        h3 { margin: 15px 0 10px; font-size: 18px; border-left: 4px solid var(--primary-color); padding-left: 10px; }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            border: 1px solid var(--border-color);
        }

        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 16px; }
        input, select {
            width: 100%; padding: 12px;
            border: 1px solid #d9e2ef;
            border-radius: 8px;
            font-size: 16px;
            background: #fff;
        }
        input:focus { outline: none; border-color: var(--primary-color); }

        .btn {
            display: inline-block; width: 100%;
            padding: 14px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            margin-bottom: 10px;
        }
        .btn:active { transform: scale(0.98); }
        .btn-success { background: var(--success-color); }
        .btn-warning { background: var(--warning-color); color: #333; }
        .btn-danger { background: var(--danger-color); }
        .btn-outline { background: transparent; border: 2px solid var(--primary-color); color: var(--primary-color); }

        .upload-area {
            border: 2px dashed #d9e2ef;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            background: #fafbfc;
            cursor: pointer;
        }
        .upload-area p { color: var(--text-secondary); font-size: 16px; }
        #preview-img { max-width: 100%; border-radius: 8px; margin-top: 15px; display: none; }

        .data-table {
            width: 100%; border-collapse: collapse;
            font-size: 14px;
        }
        .data-table th, .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        .data-table th { background: #f8f9fa; color: var(--text-secondary); font-weight: 600; }
        .highlight-row { background-color: #e3fcef; }
        .return-price-text { color: var(--danger-color); font-weight: bold; font-size: 16px; }

        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white;
            padding: 12px 24px; border-radius: 50px;
            font-size: 14px; z-index: 2000;
            display: none;
        }
        
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color);
            border-radius: 50%; width: 30px; height: 30px;
            animation: spin 1s linear infinite; margin: 20px auto; display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .secret-info { font-family: monospace; background: #eee; padding: 5px; border-radius: 4px; word-break: break-all; }
        
        .progress-bar {
            width: 100%; height: 8px; background: #e9ecef;
            border-radius: 4px; overflow: hidden; margin: 10px 0;
            display: none;
        }
        .progress-fill {
            height: 100%; background: var(--primary-color);
            width: 0%; transition: width 0.3s;
        }
        .progress-text {
            font-size: 12px; color: var(--text-secondary);
            text-align: center; margin-top: 5px; display: none;
        }

        .status-box {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        .status-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status-loading { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    </style>
</head>
<body>

    <!-- é¡µé¢ 1: é¦–é¡µ (OCR è¯†åˆ«) -->
    <div id="page-home" class="page active">
        <h1>ğŸ“¸ ç‡ƒæ–™è¿‡ç£…å•è¯†åˆ«</h1>
        
        <div class="card">
            <div id="ocr-status" class="status-box status-loading">
                ğŸ”§ æ­£åœ¨åˆå§‹åŒ– OCR æœåŠ¡...
            </div>
            
            <div class="upload-area" onclick="document.getElementById('file-input').click()">
                <p>ç‚¹å‡»æ‹ç…§ æˆ– ä»ç›¸å†Œé€‰æ‹©å›¾ç‰‡</p>
                <input type="file" id="file-input" accept="image/*" capture="environment" style="display: none" onchange="handleFileSelect(event)">
            </div>
            <img id="preview-img" alt="é¢„è§ˆ">
            
            <div id="loading" class="loader"></div>
            <div id="progress-bar" class="progress-bar">
                <div id="progress-fill" class="progress-fill"></div>
            </div>
            <div id="progress-text" class="progress-text">è¯†åˆ«ä¸­...</div>
            
            <button class="btn" onclick="startRecognition()" id="btn-recognize" style="display:none;">å¼€å§‹è¯†åˆ«</button>
        </div>

        <div id="recognition-result" class="card" style="display:none;">
            <h3>ğŸ” è¯†åˆ«ç»“æœæ ¸å¯¹</h3>
            <p style="font-size:12px; color:#666; margin-bottom:10px;">è¯·æ ¸å¯¹ä»¥ä¸‹ä¿¡æ¯ï¼Œå¦‚æœ‰é”™è¯¯å¯ç›´æ¥ä¿®æ”¹ï¼š</p>
            
            <form id="verify-form">
                <div class="form-group"><label>ä¾›åº”å•†</label><input type="text" id="v-supplier"></div>
                <div class="form-group"><label>è½¦ç‰Œå·</label><input type="text" id="v-plate"></div>
                <div class="form-group"><label>ç‡ƒæ–™ç§ç±»</label><input type="text" id="v-fuel"></div>
                <div class="form-group"><label>æ—¥æœŸ (å•å·å‰ 8 ä½)</label><input type="date" id="v-date"></div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div class="form-group"><label>æ¯›é‡ (å¨)</label><input type="number" step="0.01" id="v-gross"></div>
                    <div class="form-group"><label>çš®é‡ (å¨)</label><input type="number" step="0.01" id="v-tare"></div>
                    <div class="form-group"><label>å‡€é‡ (å¨)</label><input type="number" step="0.01" id="v-net"></div>
                    <div class="form-group"><label>æ€»é‡ (ç”¨äºè¿è´¹è®¡ç®—)</label><input type="number" step="0.01" id="v-total-weight" readonly></div>
                </div>

                <h4>æ‰£æ‚ä¿¡æ¯ (%)</h4>
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
                    <div class="form-group"><label>æ‚è´¨</label><input type="number" step="0.01" id="v-deduct-impurity" value="0"></div>
                    <div class="form-group"><label>éœ‰è…</label><input type="number" step="0.01" id="v-deduct-mold" value="0"></div>
                    <div class="form-group"><label>é•¿æ†</label><input type="number" step="0.01" id="v-deduct-long" value="0"></div>
                </div>
                <div class="form-group"><label>æ‰£é™¤é‡é‡ (å¨)</label><input type="number" step="0.01" id="v-deduct-weight" readonly></div>
                <div class="form-group"><label>æœ€ç»ˆç»“ç®—å‡€é‡ (å¨)</label><input type="number" step="0.01" id="v-final-net" readonly style="background:#f0f0f0; font-weight:bold;"></div>
            </form>

            <button class="btn btn-success" onclick="confirmData()">âœ… ç¡®è®¤æ— è¯¯ï¼Œå»è®¡ç®—è´§æ¬¾</button>
        </div>
    </div>

    <!-- é¡µé¢ 2: æ•°æ®æŸ¥è¯¢ä¸å¯¼å‡º -->
    <div id="page-data" class="page">
        <h1>ğŸ“Š è´§ç‰©äº¤ä»˜è®°å½•</h1>
        
        <div class="card">
            <div class="form-group">
                <input type="text" id="search-input" placeholder="æœç´¢è½¦ç‰Œã€æ—¥æœŸæˆ–ç‡ƒæ–™..." onkeyup="renderTable()">
            </div>
            <div style="overflow-x:auto;">
                <table class="data-table" id="records-table">
                    <thead>
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>è½¦ç‰Œ</th>
                            <th>ç‡ƒæ–™</th>
                            <th>ç»“ç®—å‡€é‡</th>
                            <th>ä»˜æ¬¾æ€»é¢</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <button class="btn btn-outline" onclick="exportAllToImage()">ğŸ“· å¯¼å‡ºå½“å‰åˆ—è¡¨</button>
    </div>

    <!-- é¡µé¢ 3: è´§æ¬¾ä»·æ ¼ç®¡ç† -->
    <div id="page-price" class="page">
        <h1>ğŸ’° è´§æ¬¾ä»·æ ¼è¡¨</h1>
        <div class="card">
            <p style="margin-bottom:15px; color:#666;">åœ¨æ­¤æ›´æ–°å„ç±»ç‡ƒæ–™çš„ç»“ç®—å•ä»· (å…ƒ/å¨)ã€‚</p>
            <div id="price-list"></div>
            <button class="btn btn-success" style="margin-top:20px;" onclick="savePrices()">ğŸ’¾ ä¿å­˜ä»·æ ¼æ›´æ–°</button>
        </div>
    </div>

    <!-- é¡µé¢ 4: è®¤è¯ä¿¡æ¯ -->
    <div id="page-auth" class="page">
        <h1>ğŸ” ç³»ç»Ÿè®¤è¯ä¿¡æ¯</h1>
        <div class="card">
            <p>ç™¾åº¦æ™ºèƒ½äº‘ OCR é…ç½® (åªè¯»)</p>
            <br>
            <div class="form-group">
                <label>App ID</label>
                <div class="secret-info">122102244</div>
            </div>
            <div class="form-group">
                <label>API Key</label>
                <div class="secret-info">NnrvJeOWeVcQ4vEdOWcT20q7</div>
            </div>
            <div class="form-group">
                <label>Secret Key</label>
                <div class="secret-info">WuIokhwPmDXPgS1Viz8m1jaIaM7dlsUY</div>
            </div>
            <p style="color:green; font-size:12px; margin-top:10px;">âœ… ä½¿ç”¨ CORS ä»£ç†è°ƒç”¨ç™¾åº¦ OCRï¼Œæ— éœ€é…ç½®ç™½åå•</p>
        </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <div class="navbar">
        <div class="nav-item active" onclick="switchPage('home', this)">
            <span class="nav-icon">ğŸ </span>é¦–é¡µ
        </div>
        <div class="nav-item" onclick="switchPage('data', this)">
            <span class="nav-icon">ğŸ“‚</span>æŸ¥è¯¢
        </div>
        <div class="nav-item" onclick="switchPage('price', this)">
            <span class="nav-icon">ğŸ’²</span>ä»·æ ¼
        </div>
        <div class="nav-item" onclick="switchPage('auth', this)">
            <span class="nav-icon">ğŸ”’</span>è®¤è¯
        </div>
    </div>

    <div id="toast" class="toast">æ“ä½œæˆåŠŸ</div>

    <script>
        // --- å…¨å±€å˜é‡ä¸é…ç½® ---
        const BAIDU_CONFIG = {
            appId: '122102244',
            apiKey: 'NnrvJeOWeVcQ4vEdOWcT20q7',
            secretKey: 'WuIokhwPmDXPgS1Viz8m1jaIaM7dlsUY'
        };

        // CORS ä»£ç†åˆ—è¡¨ï¼ˆå¤šä¸ªå¤‡ç”¨ï¼‰
        const CORS_PROXIES = [
            'https://api.allorigins.win/raw?url=',
            'https://corsproxy.io/?',
            'https://api.codetabs.com/v1/proxy?quest='
        ];

        let priceList = [
            { name: "å¸¦å¶è–ªæŸ´ä¸‰çº§", price: 270 },
            { name: "å¹²æ ‘æäºŒçº§", price: 240 },
            { name: "å¹²æ ‘æä¸€çº§", price: 298 },
            { name: "æ‰æœ¨æ ‘æäºŒçº§", price: 242 },
            { name: "æ‰æœ¨æ ‘æä¸€çº§", price: 202 },
            { name: "æ¨æ ‘çš®äºŒçº§", price: 247 },
            { name: "æ¨æ ‘çš®ä¸€çº§", price: 180 },
            { name: "ææ¡ æŸ´ä¸‰çº§", price: 202 },
            { name: "ç«¹æ", price: 222 }
        ];

        let records = JSON.parse(localStorage.getItem('delivery_records')) || [];
        let currentImageBase64 = "";
        let currentImageFile = null;
        let accessToken = "";
        let tokenExpiresAt = 0;

        window.onload = async function() {
            renderPriceList();
            renderTable();
            document.querySelectorAll('#verify-form input').forEach(input => {
                input.addEventListener('input', calculateDeductions);
            });
            
            // åˆå§‹åŒ–æ—¶è·å– Access Token
            await initBaiduOCR();
        };

        function switchPage(pageId, navEl) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if(navEl) navEl.classList.add('active');

            if(pageId === 'data') renderTable();
            if(pageId === 'price') renderPriceList();
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        function updateStatus(message, type) {
            const statusBox = document.getElementById('ocr-status');
            statusBox.className = `status-box status-${type}`;
            
            const icons = {
                'success': 'âœ…',
                'error': 'âŒ',
                'loading': 'ğŸ”„'
            };
            
            statusBox.innerHTML = `${icons[type] || 'ğŸ“Œ'} ${message}`;
        }

        // --- ç™¾åº¦ OCR åˆå§‹åŒ– ---
        async function initBaiduOCR() {
            updateStatus('æ­£åœ¨è¿æ¥ç™¾åº¦ OCR æœåŠ¡...', 'loading');
            
            try {
                await getAccessToken();
                updateStatus('âœ… OCR æœåŠ¡å·²å°±ç»ªï¼Œå¯ä»¥å¼€å§‹è¯†åˆ«', 'success');
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                updateStatus('âš ï¸ OCR æœåŠ¡è¿æ¥å¤±è´¥ï¼Œå°†å°è¯•å¤‡ç”¨æ–¹æ¡ˆ', 'error');
            }
        }

        async function getAccessToken() {
            // æ£€æŸ¥ç¼“å­˜çš„ token æ˜¯å¦æœ‰æ•ˆ
            if (accessToken && Date.now() < tokenExpiresAt) {
                console.log('ä½¿ç”¨ç¼“å­˜çš„ Access Token');
                return accessToken;
            }

            const url = `https://aip.baidubce.com/oauth/2.0/token?grant_type=client_credentials&client_id=${BAIDU_CONFIG.apiKey}&client_secret=${BAIDU_CONFIG.secretKey}`;
            
            // å°è¯•å¤šä¸ª CORS ä»£ç†
            for (const proxy of CORS_PROXIES) {
                try {
                    console.log(`å°è¯•ä»£ç†: ${proxy}`);
                    const response = await fetch(proxy + encodeURIComponent(url));
                    
                    if (!response.ok) continue;
                    
                    const data = await response.json();
                    
                    if (data.access_token) {
                        accessToken = data.access_token;
                        // token æœ‰æ•ˆæœŸé€šå¸¸ 30 å¤©ï¼Œæˆ‘ä»¬è®¾ç½® 29 å¤©è¿‡æœŸ
                        tokenExpiresAt = Date.now() + (29 * 24 * 60 * 60 * 1000);
                        console.log('è·å– Access Token æˆåŠŸ');
                        return accessToken;
                    }
                } catch (e) {
                    console.log(`ä»£ç† ${proxy} å¤±è´¥:`, e.message);
                    continue;
                }
            }
            
            throw new Error('æ‰€æœ‰ CORS ä»£ç†å‡å¤±è´¥');
        }

        // --- é¦–é¡µï¼šå›¾ç‰‡å¤„ç†ä¸ OCR ---
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            currentImageFile = file;

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById('preview-img');
                img.src = e.target.result;
                img.style.display = 'block';
                currentImageBase64 = e.target.result.split(',')[1]; // å»æ‰ data:image/jpeg;base64, å‰ç¼€
                document.getElementById('btn-recognize').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        async function startRecognition() {
            if (!currentImageBase64) {
                alert("è¯·å…ˆé€‰æ‹©å›¾ç‰‡ï¼");
                return;
            }
            
            const loader = document.getElementById('loading');
            const progressBar = document.getElementById('progress-bar');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            const btn = document.getElementById('btn-recognize');
            
            loader.style.display = 'block';
            progressBar.style.display = 'block';
            progressText.style.display = 'block';
            progressFill.style.width = '30%';
            progressText.innerText = 'æ­£åœ¨è·å–è®¤è¯...';
            btn.disabled = true;
            btn.innerText = "è¯†åˆ«ä¸­...";

            try {
                // 1. è·å– Access Token
                await getAccessToken();
                progressFill.style.width = '60%';
                progressText.innerText = 'æ­£åœ¨è¯†åˆ«å›¾ç‰‡...';
                
                // 2. è°ƒç”¨ OCR æ¥å£ï¼ˆé€šè¿‡ CORS ä»£ç†ï¼‰
                const ocrUrl = `https://aip.baidubce.com/rest/2.0/ocr/v1/accurate_basic?access_token=${accessToken}`;
                
                let ocrResult = null;
                
                // å°è¯•å¤šä¸ª CORS ä»£ç†
                for (const proxy of CORS_PROXIES) {
                    try {
                        console.log(`å°è¯• OCR ä»£ç†ï¼š${proxy}`);
                        
                        const response = await fetch(proxy + encodeURIComponent(ocrUrl), {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded'
                            },
                            body: `image=${encodeURIComponent(currentImageBase64)}`
                        });

                        if (!response.ok) {
                            console.log(`ä»£ç† ${proxy} è¿”å›çŠ¶æ€ï¼š`, response.status);
                            continue;
                        }
                        
                        const result = await response.json();
                        
                        if (result.error_code) {
                            throw new Error(result.error_msg || "è¯†åˆ«å¤±è´¥");
                        }
                        
                        ocrResult = result;
                        break;
                        
                    } catch (e) {
                        console.log(`ä»£ç† ${proxy} å¤±è´¥:`, e.message);
                        continue;
                    }
                }
                
                if (!ocrResult) {
                    throw new Error('æ‰€æœ‰ä»£ç†å‡æ— æ³•å®Œæˆ OCR è¯†åˆ«');
                }
                
                progressFill.style.width = '100%';
                progressText.innerText = 'è¯†åˆ«å®Œæˆï¼';
                
                parseOCRResult(ocrResult.words_result);
                showToast("è¯†åˆ«æˆåŠŸï¼Œè¯·æ ¸å¯¹");

            } catch (error) {
                console.error(error);
                updateStatus('âŒ è¯†åˆ«å¤±è´¥ï¼š' + error.message, 'error');
                alert("è¯†åˆ«å¤±è´¥ï¼š" + error.message + "\n\nè¯·æ£€æŸ¥ï¼š\n1. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n2. å›¾ç‰‡æ˜¯å¦æ¸…æ™°\n3. ç¨åé‡è¯•");
            } finally {
                loader.style.display = 'none';
                progressBar.style.display = 'none';
                progressText.style.display = 'none';
                btn.disabled = false;
                btn.innerText = "é‡æ–°è¯†åˆ«";
            }
        }

        function parseOCRResult(wordsList) {
            console.log("è¯†åˆ«åˆ°çš„æ–‡å­—:", wordsList);
            
            const textMap = {};
            
            wordsList.forEach(item => {
                const text = item.words.trim();
                
                // ä¾›åº”å•†
                if (text.includes('ä¾›åº”å•†') || text.includes('å®‰ä¹¡')) {
                    textMap.supplier = extractValue(text);
                }
                // è½¦ç‰Œå·
                if (text.includes('è½¦ç‰Œå·') || text.match(/æ¹˜ [A-Z0-9]+/)) {
                    const match = text.match(/æ¹˜ [A-Z0-9]+/);
                    if (match) textMap.plate = match[0];
                }
                // ç‡ƒæ–™ç§ç±»
                if (text.includes('ç‡ƒæ–™ç§ç±»') || text.includes('ç‡ƒæ–™')) {
                    textMap.fuel = extractValue(text);
                }
                // å•å·/æ—¥æœŸ
                if (text.includes('å•å·')) {
                    const val = extractValue(text);
                    const match = val.match(/(\d{8})/);
                    if (match) {
                        const dateStr = match[1].substring(0, 4) + '-' + match[1].substring(4, 6) + '-' + match[1].substring(6, 8);
                        textMap.date = dateStr;
                    }
                }
                // æ¯›é‡
                if (text.includes('æ¯›é‡')) {
                    const match = text.match(/(\d+\.?\d*)/);
                    if (match) textMap.gross = parseFloat(match[1]) || 0;
                }
                // çš®é‡
                if (text.includes('çš®é‡')) {
                    const match = text.match(/(\d+\.?\d*)/);
                    if (match) textMap.tare = parseFloat(match[1]) || 0;
                }
                // å‡€é‡
                if (text.includes('å‡€é‡')) {
                    const match = text.match(/(\d+\.?\d*)/);
                    if (match) textMap.net = parseFloat(match[1]) || 0;
                }
                // æ‰£æ‚è´¨
                if (text.includes('æ‰£æ‚è´¨') || text.includes('æ‚è´¨')) {
                    const match = text.match(/(\d+\.?\d*)/);
                    if (match) textMap.impurity = parseFloat(match[1]) || 0;
                }
                // æ‰£éœ‰è…
                if (text.includes('æ‰£éœ‰è…') || text.includes('éœ‰è…')) {
                    const match = text.match(/(\d+\.?\d*)/);
                    if (match) textMap.mold = parseFloat(match[1]) || 0;
                }
                // æ‰£é•¿æ†
                if (text.includes('æ‰£é•¿æ†') || text.includes('é•¿æ†')) {
                    const match = text.match(/(\d+\.?\d*)/);
                    if (match) textMap.longStick = parseFloat(match[1]) || 0;
                }
                // æ‰£é™¤é‡é‡
                if (text.includes('æ‰£é™¤é‡é‡')) {
                    const match = text.match(/(\d+\.?\d*)/);
                    if (match) textMap.deductWeight = parseFloat(match[1]) || 0;
                }
            });

            // å¡«å……è¡¨å•
            document.getElementById('v-supplier').value = textMap.supplier || "å®‰ä¹¡å¿é¡ºæ¸…ç§¸ç§†ç»¼åˆåˆ©ç”¨ä¸“ä¸šåˆä½œç¤¾";
            document.getElementById('v-plate').value = textMap.plate || "";
            document.getElementById('v-fuel').value = textMap.fuel || "";
            document.getElementById('v-date').value = textMap.date || new Date().toISOString().split('T')[0];
            
            document.getElementById('v-gross').value = textMap.gross ? textMap.gross.toFixed(2) : "";
            document.getElementById('v-tare').value = textMap.tare ? textMap.tare.toFixed(2) : "";
            document.getElementById('v-net').value = textMap.net ? textMap.net.toFixed(2) : "";
            
            document.getElementById('v-deduct-impurity').value = textMap.impurity || 0;
            document.getElementById('v-deduct-mold').value = textMap.mold || 0;
            document.getElementById('v-deduct-long').value = textMap.longStick || 0;
            document.getElementById('v-deduct-weight').value = (textMap.deductWeight || 0).toFixed(2);

            calculateDeductions();

            document.getElementById('recognition-result').style.display = 'block';
            document.getElementById('recognition-result').scrollIntoView({behavior: "smooth"});
            updateStatus('âœ… è¯†åˆ«æˆåŠŸï¼Œè¯·æ ¸å¯¹æ•°æ®', 'success');
        }

        function extractValue(str) {
            const parts = str.split(/[:ï¼š]/);
            if (parts.length > 1) return parts.slice(1).join(':').trim();
            return str.trim();
        }

        function calculateDeductions() {
            const gross = parseFloat(document.getElementById('v-gross').value) || 0;
            const tare = parseFloat(document.getElementById('v-tare').value) || 0;
            const net = parseFloat(document.getElementById('v-net').value) || 0;
            
            const impurity = parseFloat(document.getElementById('v-deduct-impurity').value) || 0;
            const mold = parseFloat(document.getElementById('v-deduct-mold').value) || 0;
            const longStick = parseFloat(document.getElementById('v-deduct-long').value) || 0;

            document.getElementById('v-total-weight').value = gross.toFixed(2);

            const totalDeductRate = impurity + mold + longStick;
            const calculatedDeductWeight = net * (totalDeductRate / 100);
            
            document.getElementById('v-deduct-weight').value = calculatedDeductWeight.toFixed(2);

            const finalNet = net - calculatedDeductWeight;
            document.getElementById('v-final-net').value = Math.max(0, finalNet).toFixed(2);
        }

        // --- ç¬¬äºŒæ­¥ï¼šç¡®è®¤æ•°æ®å¹¶è®¡ç®— ---
        function confirmData() {
            const supplier = document.getElementById('v-supplier').value;
            const plate = document.getElementById('v-plate').value;
            const fuel = document.getElementById('v-fuel').value;
            const date = document.getElementById('v-date').value;
            const finalNet = parseFloat(document.getElementById('v-final-net').value);
            const grossWeight = parseFloat(document.getElementById('v-total-weight').value);
            
            if(!finalNet || !plate) {
                alert("è¯·ç¡®ä¿è½¦ç‰Œå·å’Œå‡€é‡å·²æ­£ç¡®è¯†åˆ«æˆ–å¡«å†™ï¼");
                return;
            }

            const inputPrice = prompt(`è¯·è¾“å…¥ã€${fuel}ã€‘çš„è´§æ¬¾å•ä»· (å…ƒ/å¨):`, "180");
            if (inputPrice === null) return;
            
            const isZheng = confirm("è¿™æ˜¯å¦æ˜¯ **éƒ‘è€æ¿** çš„è´§ç‰©ï¼Ÿ\n\næ˜¯ï¼šæ‰£é™¤è¿è´¹ (50 å…ƒ/å¨ * æ€»é‡)\nå¦ï¼šæ­£å¸¸ç»“ç®—");

            const unitPrice = parseFloat(inputPrice);
            if (isNaN(unitPrice)) {
                alert("ä»·æ ¼è¾“å…¥æ— æ•ˆï¼");
                return;
            }

            let paymentTotal = 0;
            let freightCost = 0;
            let calculationDetail = "";

            if (isZheng) {
                const originalNet = parseFloat(document.getElementById('v-net').value);
                freightCost = 50 * originalNet; 
                
                const grossValue = finalNet * unitPrice;
                paymentTotal = grossValue - freightCost;
                
                calculationDetail = `ç»“ç®—ä»· (${finalNet}å¨ Ã— ${unitPrice}å…ƒ) - è¿è´¹ (${originalNet}å¨ Ã— 50 å…ƒ)`;
            } else {
                paymentTotal = finalNet * unitPrice;
                calculationDetail = `ç»“ç®—ä»· (${finalNet}å¨ Ã— ${unitPrice}å…ƒ)`;
            }

            const priceItem = priceList.find(p => p.name === fuel);
            const sellPrice = priceItem ? priceItem.price : unitPrice;
            const returnValue = finalNet * sellPrice;

            const record = {
                id: Date.now(),
                date: date,
                supplier: supplier,
                plate: plate,
                fuel: fuel,
                finalNet: finalNet,
                unitPrice: unitPrice,
                isZheng: isZheng,
                freightCost: freightCost,
                paymentTotal: paymentTotal,
                sellPrice: sellPrice,
                returnValue: returnValue,
                calculation: calculationDetail,
                image: currentImageBase64
            };

            records.unshift(record);
            saveToLocal();
            
            document.getElementById('verify-form').reset();
            document.getElementById('recognition-result').style.display = 'none';
            document.getElementById('preview-img').style.display = 'none';
            document.getElementById('btn-recognize').style.display = 'none';
            currentImageBase64 = "";
            currentImageFile = null;
            
            showToast("âœ… ä¿å­˜æˆåŠŸï¼æ•°æ®å·²å½•å…¥ã€‚");
            updateStatus('âœ… OCR æœåŠ¡å·²å°±ç»ªï¼Œå¯ä»¥å¼€å§‹è¯†åˆ«', 'success');
            switchPage('data', document.querySelectorAll('.nav-item')[1]);
        }

        function saveToLocal() {
            try {
                localStorage.setItem('delivery_records', JSON.stringify(records));
            } catch (e) {
                alert("å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œæ— æ³•ä¿å­˜æ›´å¤šå›¾ç‰‡ã€‚å»ºè®®å¯¼å‡ºåæ¸…ç†æ•°æ®ã€‚");
            }
        }

        // --- é¡µé¢äºŒï¼šæ•°æ®å±•ç¤ºä¸å¯¼å‡º ---
        function renderTable() {
            const tbody = document.querySelector('#records-table tbody');
            const filter = document.getElementById('search-input').value.toLowerCase();
            tbody.innerHTML = '';

            records.forEach((r, index) => {
                if (r.plate.toLowerCase().includes(filter) || r.date.includes(filter) || r.fuel.includes(filter)) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${r.date}</td>
                        <td>${r.plate}</td>
                        <td>${r.fuel}</td>
                        <td>${r.finalNet.toFixed(2)}</td>
                        <td style="color:${r.isZheng?'red':'green'}">Â¥${r.paymentTotal.toFixed(2)}</td>
                        <td>
                            <button class="btn-outline" style="padding:4px 8px; font-size:12px;" onclick="viewDetail(${index})">è¯¦æƒ…</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                }
            });
        }

        function viewDetail(index) {
            const r = records[index];
            let info = `æ—¥æœŸï¼š${r.date}\nè½¦ç‰Œï¼š${r.plate}\nç‡ƒæ–™ï¼š${r.fuel}\nç»“ç®—å‡€é‡ï¼š${r.finalNet}å¨\n`;
            info += `------------------\n`;
            info += `è®¡ç®—æ–¹å¼ï¼š${r.calculation}\n`;
            if(r.isZheng) info += `æ‰£é™¤è¿è´¹ï¼šÂ¥${r.freightCost.toFixed(2)}\n`;
            info += `ä»˜æ¬¾æ€»é¢ï¼šÂ¥${r.paymentTotal.toFixed(2)}\n`;
            info += `------------------\n`;
            info += `å›æ¬¾ä»·æ ¼ (å†…éƒ¨): Â¥${r.returnValue.toFixed(2)}\n`;
            info += `(æ­¤ä»·æ ¼ä¸å¯¼å‡º)`;
            
            alert(info);
        }

        function exportAllToImage() {
            const content = records.map(r => 
                `${r.date} | ${r.plate} | ${r.fuel} | å‡€é‡:${r.finalNet} | æ€»é¢:${r.paymentTotal.toFixed(2)}${r.isZheng?' (å«è¿è´¹æ‰£å‡)':''}`
            ).join('\n');
            
            const blob = new Blob([content], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `è´§ç‰©äº¤ä»˜è®°å½•_${new Date().toLocaleDateString()}.txt`;
            a.click();
            
            alert("å·²å¯¼å‡ºä¸º TXT æ–‡ä»¶ã€‚\nå¦‚éœ€å›¾ç‰‡æ ¼å¼ï¼Œè¯·åœ¨æ•°æ®åˆ—è¡¨é¡µä½¿ç”¨æ‰‹æœºæˆªå±åŠŸèƒ½ã€‚");
        }

        // --- é¡µé¢ä¸‰ï¼šä»·æ ¼ç®¡ç† ---
        function renderPriceList() {
            const container = document.getElementById('price-list');
            container.innerHTML = '';
            priceList.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'form-group';
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.justifyContent = 'space-between';
                div.innerHTML = `
                    <label style="margin:0; width:60%;">${item.name}</label>
                    <input type="number" step="0.01" value="${item.price}" style="width:35%;" data-index="${index}">
                `;
                container.appendChild(div);
            });
        }

        function savePrices() {
            const inputs = document.querySelectorAll('#price-list input');
            inputs.forEach(input => {
                const idx = input.getAttribute('data-index');
                priceList[idx].price = parseFloat(input.value) || 0;
            });
            localStorage.setItem('price_list', JSON.stringify(priceList));
            showToast("ä»·æ ¼è¡¨å·²æ›´æ–°ï¼");
        }

        const savedPrices = localStorage.getItem('price_list');
        if(savedPrices) priceList = JSON.parse(savedPrices);
    </script>
</body>
</html>
