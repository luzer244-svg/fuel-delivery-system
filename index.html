<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç»¿è‰²èƒ½æºè´§ç‰©äº¤ä»˜ç³»ç»Ÿ (ä¿®å¤ç‰ˆ)</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
    <style>
        :root { --primary: #2c7be5; --success: #00d97e; --warning: #f6c343; --danger: #e63757; --bg: #f5f7fb; --card: #fff; --text: #12263f; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; }
        body { background: var(--bg); color: var(--text); padding-bottom: 70px; }
        .nav { position: fixed; bottom: 0; width: 100%; background: var(--card); display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 999; }
        .nav-item { text-align: center; font-size: 12px; color: #6e84a3; flex: 1; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-icon { font-size: 20px; display: block; margin-bottom: 2px; }
        .page { display: none; padding: 15px; animation: fade 0.3s; }
        .page.active { display: block; }
        @keyframes fade { from { opacity: 0; } to { opacity: 1; } }
        h1 { font-size: 22px; margin-bottom: 15px; color: var(--text); }
        h3 { font-size: 18px; margin: 15px 0 10px; border-left: 4px solid var(--primary); padding-left: 10px; }
        .card { background: var(--card); border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .form-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #d9e2ef; border-radius: 6px; font-size: 16px; }
        input:focus { border-color: var(--primary); outline: none; }
        .btn { width: 100%; padding: 12px; background: var(--primary); color: #fff; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn:active { opacity: 0.9; }
        .btn-success { background: var(--success); }
        .btn-warning { background: var(--warning); color: #333; }
        .btn-danger { background: var(--danger); }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .upload-box { border: 2px dashed #d9e2ef; padding: 20px; text-align: center; border-radius: 8px; background: #fafbfc; cursor: pointer; }
        #preview { max-width: 100%; margin-top: 10px; border-radius: 6px; display: none; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 10px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .progress { width: 100%; height: 6px; background: #eee; border-radius: 3px; margin: 10px 0; display: none; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.2s; }
        .status-text { font-size: 12px; color: #666; text-align: center; margin-top: 5px; display: none; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #666; }
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: #fff; padding: 10px 20px; border-radius: 20px; font-size: 14px; z-index: 1000; display: none; }
        .debug-box { background: #f8f9fa; border: 1px solid #ddd; border-radius: 6px; padding: 10px; margin-top: 10px; font-size: 12px; max-height: 150px; overflow-y: auto; white-space: pre-wrap; display: none; }
        .debug-title { font-weight: bold; margin-bottom: 5px; color: #666; }
    </style>
</head>
<body>

    <div id="page-home" class="page active">
        <h1>ğŸ“¸ è¿‡ç£…å•å½•å…¥</h1>
        
        <div class="card">
            <div class="upload-box" onclick="document.getElementById('fileInput').click()">
                <p>ç‚¹å‡»æ‹ç…§æˆ–é€‰æ‹©å›¾ç‰‡</p>
                <input type="file" id="fileInput" accept="image/*" capture="environment" style="display:none" onchange="handleFile(event)">
            </div>
            <img id="preview" alt="é¢„è§ˆ">
            
            <div id="loader" class="loader"></div>
            <div id="progress" class="progress"><div id="pBar" class="progress-bar"></div></div>
            <div id="statusText" class="status-text">å‡†å¤‡å°±ç»ª</div>

            <button id="btnRec" class="btn" style="display:none" onclick="startOCR()">ğŸš€ å¼€å§‹æ™ºèƒ½è¯†åˆ«</button>
            <button class="btn btn-warning" onclick="enableManual()">âœï¸ è·³è¿‡è¯†åˆ«ï¼Œæ‰‹åŠ¨è¾“å…¥</button>
            
            <!-- è°ƒè¯•åŒºåŸŸï¼šæ˜¾ç¤ºè¯†åˆ«åˆ°çš„åŸå§‹æ–‡å­— -->
            <div id="debugBox" class="debug-box">
                <div class="debug-title">ğŸ“‹ è¯†åˆ«åˆ°çš„åŸå§‹æ–‡å­—ï¼š</div>
                <div id="debugText"></div>
            </div>
        </div>

        <div id="formArea" class="card" style="display:none">
            <h3>ğŸ“ æ•°æ®æ ¸å¯¹</h3>
            <div class="form-group"><label>ä¾›åº”å•†</label><input type="text" id="f_supplier" value="å®‰ä¹¡å¿é¡ºæ¸…ç§¸ç§†ç»¼åˆåˆ©ç”¨ä¸“ä¸šåˆä½œç¤¾"></div>
            <div class="form-group"><label>è½¦ç‰Œå·</label><input type="text" id="f_plate" placeholder="æ¹˜J..."></div>
            <div class="form-group"><label>ç‡ƒæ–™ç§ç±»</label>
                <select id="f_fuel">
                    <option value="ææ¡ æŸ´ä¸‰çº§">ææ¡ æŸ´ä¸‰çº§</option>
                    <option value="æ¨æ ‘çš®ä¸€çº§">æ¨æ ‘çš®ä¸€çº§</option>
                    <option value="æ¨æ ‘çš®äºŒçº§">æ¨æ ‘çš®äºŒçº§</option>
                    <option value="æ‰æœ¨æ ‘æä¸€çº§">æ‰æœ¨æ ‘æä¸€çº§</option>
                    <option value="æ‰æœ¨æ ‘æäºŒçº§">æ‰æœ¨æ ‘æäºŒçº§</option>
                    <option value="å¹²æ ‘æä¸€çº§">å¹²æ ‘æä¸€çº§</option>
                    <option value="å¹²æ ‘æäºŒçº§">å¹²æ ‘æäºŒçº§</option>
                    <option value="å¸¦å¶è–ªæŸ´ä¸‰çº§">å¸¦å¶è–ªæŸ´ä¸‰çº§</option>
                    <option value="ç«¹æ">ç«¹æ</option>
                </select>
            </div>
            <div class="form-group"><label>æ—¥æœŸ</label><input type="date" id="f_date"></div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div class="form-group"><label>æ¯›é‡</label><input type="number" step="0.01" id="f_gross" oninput="calc()"></div>
                <div class="form-group"><label>çš®é‡</label><input type="number" step="0.01" id="f_tare" oninput="calc()"></div>
                <div class="form-group"><label>å‡€é‡</label><input type="number" step="0.01" id="f_net" oninput="calc()"></div>
                <div class="form-group"><label>ç»“ç®—å‡€é‡</label><input type="number" step="0.01" id="f_final" readonly style="background:#eee"></div>
            </div>

            <div class="form-group"><label>æ‰£æ‚åˆè®¡ (%)</label><input type="number" step="0.01" id="f_deduct" value="0" oninput="calc()"></div>
            
            <button class="btn btn-success" onclick="saveData()">âœ… ç¡®è®¤ä¿å­˜</button>
        </div>
    </div>

    <div id="page-data" class="page">
        <h1>ğŸ“Š å†å²è®°å½•</h1>
        <div class="card">
            <input type="text" id="search" placeholder="æœç´¢è½¦ç‰Œ/æ—¥æœŸ..." onkeyup="renderList()" style="margin-bottom:10px">
            <div style="overflow-x:auto">
                <table id="tbl">
                    <thead><tr><th>æ—¥æœŸ</th><th>è½¦ç‰Œ</th><th>å‡€é‡</th><th>æ€»é¢</th><th>æ“ä½œ</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <button class="btn btn-outline" onclick="exportData()">ğŸ“¥ å¯¼å‡ºè¡¨æ ¼</button>
        <button class="btn btn-danger" style="margin-top:10px" onclick="clearData()">ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®</button>
    </div>

    <div id="page-price" class="page">
        <h1>ğŸ’° ä»·æ ¼ç®¡ç†</h1>
        <div class="card" id="priceBox"></div>
        <button class="btn btn-success" onclick="savePrice()">ğŸ’¾ ä¿å­˜ä»·æ ¼</button>
    </div>

    <div id="page-about" class="page">
        <h1>â„¹ï¸ ç³»ç»Ÿä¿¡æ¯</h1>
        <div class="card">
            <p>ç‰ˆæœ¬ï¼šv3.1 ä¿®å¤ç‰ˆ</p>
            <p>è¯†åˆ«å¼•æ“ï¼šTesseract.js (æœ¬åœ°è¿è¡Œ)</p>
            <p>æ•°æ®å­˜å‚¨ï¼šæ‰‹æœºæœ¬åœ°å­˜å‚¨</p>
            <p style="color:green; margin-top:10px">âœ… å¢åŠ è¯†åˆ«è°ƒè¯•åŠŸèƒ½</p>
        </div>
    </div>

    <div class="nav">
        <div class="nav-item active" onclick="sw('home',this)"><span class="nav-icon">ğŸ </span>é¦–é¡µ</div>
        <div class="nav-item" onclick="sw('data',this)"><span class="nav-icon">ğŸ“‚</span>è®°å½•</div>
        <div class="nav-item" onclick="sw('price',this)"><span class="nav-icon">ğŸ’²</span>ä»·æ ¼</div>
        <div class="nav-item" onclick="sw('about',this)"><span class="nav-icon">â„¹ï¸</span>å…³äº</div>
    </div>

    <div id="toast" class="toast">æç¤º</div>

    <script>
        let prices = JSON.parse(localStorage.getItem('prices')) || [
            {n:"ææ¡ æŸ´ä¸‰çº§", p:202}, {n:"æ¨æ ‘çš®ä¸€çº§", p:180}, {n:"æ¨æ ‘çš®äºŒçº§", p:247},
            {n:"æ‰æœ¨æ ‘æä¸€çº§", p:202}, {n:"æ‰æœ¨æ ‘æäºŒçº§", p:242}, {n:"å¹²æ ‘æä¸€çº§", p:298},
            {n:"å¹²æ ‘æäºŒçº§", p:240}, {n:"å¸¦å¶è–ªæŸ´ä¸‰çº§", p:270}, {n:"ç«¹æ", p:222}
        ];
        let records = JSON.parse(localStorage.getItem('records')) || [];
        let curImg = null;

        window.onload = () => {
            document.getElementById('f_date').valueAsDate = new Date();
            renderPrice();
            renderList();
        };

        function sw(id, el) {
            document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
            document.getElementById('page-'+id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
            if(el) el.classList.add('active');
            if(id==='data') renderList();
            if(id==='price') renderPrice();
        }

        function toast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.display='block';
            setTimeout(()=>t.style.display='none', 2000);
        }

        function handleFile(e) {
            const f = e.target.files[0];
            if(!f) return;
            curImg = f;
            const r = new FileReader();
            r.onload = (ev) => {
                const img = document.getElementById('preview');
                img.src = ev.target.result;
                img.style.display = 'block';
                document.getElementById('btnRec').style.display = 'block';
                document.getElementById('debugBox').style.display = 'none';
            };
            r.readAsDataURL(f);
        }

        async function startOCR() {
            if(!curImg) return alert('è¯·å…ˆé€‰å›¾');
            if(typeof Tesseract === 'undefined') return alert('è¯†åˆ«å¼•æ“åŠ è½½å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥');
            
            document.getElementById('btnRec').disabled = true;
            document.getElementById('loader').style.display = 'block';
            document.getElementById('progress').style.display = 'block';
            document.getElementById('statusText').style.display = 'block';
            document.getElementById('debugBox').style.display = 'block';
            document.getElementById('debugText').innerText = 'æ­£åœ¨è¯†åˆ«...';

            try {
                const worker = await Tesseract.createWorker({
                    logger: m => {
                        if(m.status === 'recognizing text') {
                            document.getElementById('pBar').style.width = (m.progress*100)+'%';
                            document.getElementById('statusText').innerText = `è¯†åˆ«ä¸­ ${Math.round(m.progress*100)}%`;
                        } else {
                            document.getElementById('statusText').innerText = m.status;
                        }
                    }
                });
                await worker.loadLanguage('chi_sim');
                await worker.initialize('chi_sim');
                const { data: { text } } = await worker.recognize(curImg);
                await worker.terminate();
                
                // æ˜¾ç¤ºè¯†åˆ«åˆ°çš„åŸå§‹æ–‡å­—
                document.getElementById('debugText').innerText = text;
                
                parseText(text);
                document.getElementById('formArea').style.display = 'block';
                toast('è¯†åˆ«å®Œæˆï¼Œè¯·æ ¸å¯¹æ•°æ®');
            } catch(err) {
                console.error(err);
                document.getElementById('debugText').innerText = 'è¯†åˆ«å¤±è´¥ï¼š' + err.message;
                alert('è¯†åˆ«å‡ºé”™ï¼š' + err.message + '\nè¯·æŸ¥çœ‹ä¸‹æ–¹è¯†åˆ«æ–‡å­—ï¼Œæ‰‹åŠ¨è¾“å…¥');
                enableManual();
            } finally {
                document.getElementById('loader').style.display = 'none';
                document.getElementById('progress').style.display = 'none';
                document.getElementById('statusText').style.display = 'none';
                document.getElementById('btnRec').disabled = false;
            }
        }

        // ä¿®å¤åçš„è§£æå‡½æ•° - æ›´æ™ºèƒ½çš„åŒ¹é…
        function parseText(txt) {
            console.log('åŸå§‹è¯†åˆ«æ–‡å­—:', txt);
            
            const lines = txt.split('\n').filter(l => l.trim().length > 0);
            let d = { plate: '', net: '', gross: '', tare: '', fuel: '', date: '' };
            
            lines.forEach(l => {
                const line = l.trim();
                console.log('å¤„ç†è¡Œ:', line);
                
                // è½¦ç‰Œå·åŒ¹é… (æ¹˜J + å­—æ¯æ•°å­—)
                if(line.includes('è½¦ç‰Œ') || line.match(/æ¹˜[A-Z0-9]{5,}/)) {
                    const m = line.match(/æ¹˜[A-Z0-9]{5,}/);
                    if(m) {
                        d.plate = m[0];
                        console.log('åŒ¹é…åˆ°è½¦ç‰Œ:', d.plate);
                    }
                }
                
                // å‡€é‡åŒ¹é… (æ‰¾"å‡€é‡"åé¢çš„æ•°å­—)
                if(line.includes('å‡€é‡')) {
                    const m = line.match(/(\d+\.?\d*)/);
                    if(m) {
                        d.net = parseFloat(m[1]);
                        console.log('åŒ¹é…åˆ°å‡€é‡:', d.net);
                    }
                }
                
                // æ¯›é‡åŒ¹é…
                if(line.includes('æ¯›é‡')) {
                    const m = line.match(/(\d+\.?\d*)/);
                    if(m) {
                        d.gross = parseFloat(m[1]);
                        console.log('åŒ¹é…åˆ°æ¯›é‡:', d.gross);
                    }
                }
                
                // çš®é‡åŒ¹é…
                if(line.includes('çš®é‡')) {
                    const m = line.match(/(\d+\.?\d*)/);
                    if(m) {
                        d.tare = parseFloat(m[1]);
                        console.log('åŒ¹é…åˆ°çš®é‡:', d.tare);
                    }
                }
                
                // ç‡ƒæ–™ç§ç±»åŒ¹é…
                if(line.includes('ç‡ƒæ–™') || line.includes('ææ¡ ') || line.includes('æ¨æ ‘') || line.includes('æ‰æœ¨') || line.includes('æ ‘æ') || line.includes('è–ªæŸ´') || line.includes('ç«¹æ')) {
                    // æå–ç‡ƒæ–™åç§°
                    const fuels = ['ææ¡ æŸ´ä¸‰çº§', 'æ¨æ ‘çš®ä¸€çº§', 'æ¨æ ‘çš®äºŒçº§', 'æ‰æœ¨æ ‘æä¸€çº§', 'æ‰æœ¨æ ‘æäºŒçº§', 'å¹²æ ‘æä¸€çº§', 'å¹²æ ‘æäºŒçº§', 'å¸¦å¶è–ªæŸ´ä¸‰çº§', 'ç«¹æ'];
                    for(const f of fuels) {
                        if(line.includes(f)) {
                            d.fuel = f;
                            console.log('åŒ¹é…åˆ°ç‡ƒæ–™:', d.fuel);
                            break;
                        }
                    }
                }
                
                // æ—¥æœŸåŒ¹é… (ä»å•å·æå– YYYYMMDD)
                if(line.includes('å•å·') || line.match(/\d{8}/)) {
                    const m = line.match(/(\d{4})(\d{2})(\d{2})/);
                    if(m) {
                        d.date = `${m[1]}-${m[2]}-${m[3]}`;
                        console.log('åŒ¹é…åˆ°æ—¥æœŸ:', d.date);
                    }
                }
            });
            
            // å¡«å……è¡¨å•
            if(d.plate) document.getElementById('f_plate').value = d.plate;
            if(d.net) document.getElementById('f_net').value = d.net;
            if(d.gross) document.getElementById('f_gross').value = d.gross;
            if(d.tare) document.getElementById('f_tare').value = d.tare;
            if(d.fuel) document.getElementById('f_fuel').value = d.fuel;
            if(d.date) document.getElementById('f_date').value = d.date;
            
            calc();
            
            // å¦‚æœå…³é”®æ•°æ®æ²¡è¯†åˆ«åˆ°ï¼Œæç¤ºç”¨æˆ·
            if(!d.plate || !d.net) {
                toast('âš ï¸ éƒ¨åˆ†æ•°æ®æœªè¯†åˆ«ï¼Œè¯·æ‰‹åŠ¨è¡¥å……');
            }
        }

        function enableManual() {
            document.getElementById('formArea').style.display = 'block';
            document.getElementById('f_supplier').value = "å®‰ä¹¡å¿é¡ºæ¸…ç§¸ç§†ç»¼åˆåˆ©ç”¨ä¸“ä¸šåˆä½œç¤¾";
            document.getElementById('debugBox').style.display = 'block';
        }

        function calc() {
            const net = parseFloat(document.getElementById('f_net').value) || 0;
            const ded = parseFloat(document.getElementById('f_deduct').value) || 0;
            const final = net * (1 - ded/100);
            document.getElementById('f_final').value = final.toFixed(2);
        }

        function saveData() {
            const plate = document.getElementById('f_plate').value;
            const fuel = document.getElementById('f_fuel').value;
            const finalNet = parseFloat(document.getElementById('f_final').value);
            if(!plate || !finalNet) return alert('è¯·å¡«å†™å®Œæ•´æ•°æ®');

            const priceObj = prices.find(x=>x.n===fuel) || {p:0};
            const unitPrice = parseFloat(prompt(`è¾“å…¥å•ä»· (é»˜è®¤${priceObj.p}):`, priceObj.p));
            if(isNaN(unitPrice)) return;

            const isZheng = confirm("æ˜¯éƒ‘è€æ¿çš„è´§å—ï¼Ÿ\n(æ˜¯ï¼šæ‰£é™¤ 50 å…ƒ/å¨ è¿è´¹)");
            
            let total = finalNet * unitPrice;
            let freight = 0;
            let detail = `æ­£å¸¸ç»“ç®—`;
            
            if(isZheng) {
                const rawNet = parseFloat(document.getElementById('f_net').value) || 0;
                freight = rawNet * 50;
                total -= freight;
                detail = `æ‰£é™¤è¿è´¹ ${freight.toFixed(2)}å…ƒ`;
            }

            const rec = {
                date: document.getElementById('f_date').value,
                plate, fuel, net: finalNet, total, detail, time: Date.now()
            };
            records.unshift(rec);
            localStorage.setItem('records', JSON.stringify(records));
            
            toast('ä¿å­˜æˆåŠŸ');
            document.getElementById('formArea').style.display = 'none';
            document.getElementById('preview').style.display = 'none';
            document.getElementById('btnRec').style.display = 'none';
            document.querySelector('.upload-box').style.display = 'block';
            document.getElementById('f_plate').value = '';
            document.getElementById('f_net').value = '';
            sw('data', document.querySelectorAll('.nav-item')[1]);
        }

        function renderList() {
            const key = document.getElementById('search').value.toLowerCase();
            const tbody = document.querySelector('#tbl tbody');
            tbody.innerHTML = '';
            records.filter(r => r.plate.toLowerCase().includes(key) || r.date.includes(key)).forEach(r => {
                const tr = `<tr>
                    <td>${r.date}</td>
                    <td>${r.plate}</td>
                    <td>${r.net.toFixed(2)}</td>
                    <td style="color:${r.total<0?'red':'green'}">Â¥${r.total.toFixed(2)}</td>
                    <td><button onclick="alert('${r.detail}\næ€»é¢ï¼š${r.total.toFixed(2)}')" style="border:none;background:none;color:blue">è¯¦æƒ…</button></td>
                </tr>`;
                tbody.innerHTML += tr;
            });
        }

        function exportData() {
            if(!records.length) return alert('æ— æ•°æ®');
            let csv = "æ—¥æœŸï¼Œè½¦ç‰Œï¼Œç‡ƒæ–™ï¼Œå‡€é‡ï¼Œæ€»é¢ï¼Œå¤‡æ³¨\n";
            records.forEach(r => csv += `${r.date},${r.plate},${r.fuel},${r.net},${r.total},${r.detail}\n`);
            const blob = new Blob(["\ufeff"+csv], {type:'text/csv'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `æ•°æ®_${new Date().toLocaleDateString()}.csv`;
            a.click();
        }

        function clearData() {
            if(confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿ')) {
                records = [];
                localStorage.removeItem('records');
                renderList();
                toast('å·²æ¸…ç©º');
            }
        }

        function renderPrice() {
            const box = document.getElementById('priceBox');
            box.innerHTML = '';
            prices.forEach((item, i) => {
                box.innerHTML += `
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px">
                        <span>${item.n}</span>
                        <input type="number" value="${item.p}" data-i="${i}" style="width:80px;padding:4px">
                    </div>
                `;
            });
        }

        function savePrice() {
            const inputs = document.querySelectorAll('#priceBox input');
            inputs.forEach(inp => {
                prices[inp.dataset.i].p = parseFloat(inp.value);
            });
            localStorage.setItem('prices', JSON.stringify(prices));
            toast('ä»·æ ¼å·²æ›´æ–°');
        }
    </script>
</body>
</html>
