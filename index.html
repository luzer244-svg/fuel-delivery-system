<!DOCTYPE html>

<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<title>货物交付系统</title>
<!-- Tailwind CSS -->
<script src="https://image.uc.cn/s/uae/g/3n/mos-production/0915/3.4.17.js"></script>
<!-- Font Awesome -->
<script src="https://image.uc.cn/s/uae/g/3n/mos-production/fontawesome-free-7.1.0-web/js/all.min.js"></script>
<link href="https://image.uc.cn/s/uae/g/3n/mos-production/fontawesome-free-7.1.0-web/css/fontawesome.min.css" rel="stylesheet"/>
<!-- html2canvas for Export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
        /* Custom styles for large text and mobile optimization */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Toast Animation */
        @keyframes slideIn {
            from { transform: translateX(-50%) translateY(100%); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .toast {
            animation: slideIn 0.3s ease-out forwards;
        }
        .toast.hiding {
            animation: fadeOut 0.3s ease-in forwards;
        }
        /* Input styling reset */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden text-gray-800">
<!-- Main Content Area -->
<main class="flex-1 overflow-y-auto no-scrollbar relative pb-20" id="app">
<!-- Page 1: Home / OCR -->
<section class="page-section p-4 space-y-4" id="page-home">
<header class="text-center mb-4">
<h1 class="text-2xl font-bold text-blue-800">货物交付系统</h1>
<p class="text-gray-500 text-sm">OCR智能识别与录入</p>
</header>
<!-- Image Input -->
<div class="bg-white p-4 rounded-xl shadow-sm">
<label class="block text-lg font-semibold mb-2 text-gray-700">1. 上传过磅单照片</label>
<div class="flex gap-2">
<button class="flex-1 bg-blue-500 text-white py-3 rounded-lg text-lg font-medium active:bg-blue-600 flex items-center justify-center gap-2 shadow-sm" onclick="document.getElementById('cameraInput').click()">
<i class="fas fa-camera"></i> 拍照
                    </button>
<button class="flex-1 bg-green-500 text-white py-3 rounded-lg text-lg font-medium active:bg-green-600 flex items-center justify-center gap-2 shadow-sm" onclick="document.getElementById('albumInput').click()">
<i class="fas fa-image"></i> 相册
                    </button>
</div>
<!-- Hidden Inputs -->
<input accept="image/*" capture="environment" class="hidden" id="cameraInput" onchange="handleImageUpload(this)" type="file"/>
<input accept="image/*" class="hidden" id="albumInput" onchange="handleImageUpload(this)" type="file"/>
<!-- Preview -->
<div class="mt-4 hidden border-2 border-dashed border-gray-300 rounded-lg p-2 relative" id="imagePreviewContainer">
<img alt="Preview" class="w-full h-48 object-contain rounded bg-gray-50" id="imagePreview" src=""/>
<button class="absolute top-2 right-2 bg-red-500 text-white w-8 h-8 rounded-full shadow-lg flex items-center justify-center z-10" onclick="clearImage()">
<i class="fas fa-times"></i>
</button>
</div>
</div>
<!-- Data Form (Initially Hidden) -->
<div class="bg-white p-4 rounded-xl shadow-sm space-y-4 hidden" id="dataFormContainer">
<div class="flex justify-between items-center border-b pb-2">
<h2 class="text-xl font-bold text-gray-800">2. 核对数据</h2>
<span class="text-xs text-blue-500 font-mono bg-blue-50 px-2 py-1 rounded" id="ocrStatus">识别完成</span>
</div>
<!-- Editable Table -->
<div class="overflow-x-auto">
<table class="w-full text-left border-collapse">
<tbody class="text-lg">
<tr class="border-b">
<td class="py-2 text-gray-600 w-1/3">供应商</td>
<td class="py-2"><input class="w-full border-b border-gray-300 focus:border-blue-500 outline-none py-1 font-medium bg-transparent" id="inpSupplier" type="text"/></td>
</tr>
<tr class="border-b">
<td class="py-2 text-gray-600">燃料种类</td>
<td class="py-2"><input class="w-full border-b border-gray-300 focus:border-blue-500 outline-none py-1 font-medium bg-transparent" id="inpFuelType" type="text"/></td>
</tr>
<tr class="border-b">
<td class="py-2 text-gray-600">日期</td>
<td class="py-2"><input class="w-full border-b border-gray-300 focus:border-blue-500 outline-none py-1 font-medium bg-transparent" id="inpDate" type="date"/></td>
</tr>
<tr class="border-b">
<td class="py-2 text-gray-600">车牌号</td>
<td class="py-2"><input class="w-full border-b border-gray-300 focus:border-blue-500 outline-none py-1 font-medium bg-transparent" id="inpPlate" type="text"/></td>
</tr>
<tr class="border-b">
<td class="py-2 text-gray-600">扣除率(%)</td>
<td class="py-2"><input class="w-full border-b border-gray-300 focus:border-blue-500 outline-none py-1 font-medium bg-transparent" id="inpDeduction" step="0.01" type="number"/></td>
</tr>
<tr class="border-b">
<td class="py-2 text-gray-600">毛重(吨)</td>
<td class="py-2"><input class="w-full border-b border-gray-300 focus:border-blue-500 outline-none py-1 font-medium bg-transparent" id="inpGross" step="0.01" type="number"/></td>
</tr>
<tr class="border-b">
<td class="py-2 text-gray-600">皮重(吨)</td>
<td class="py-2"><input class="w-full border-b border-gray-300 focus:border-blue-500 outline-none py-1 font-medium bg-transparent" id="inpTare" step="0.01" type="number"/></td>
</tr>
<tr class="border-b">
<td class="py-2 text-gray-600">净重(吨)</td>
<td class="py-2"><input class="w-full border-b border-gray-300 focus:border-blue-500 outline-none py-1 font-medium bg-transparent" id="inpNet" step="0.01" type="number"/></td>
</tr>
</tbody>
</table>
</div>
<!-- Calculation Inputs -->
<div class="bg-blue-50 p-4 rounded-lg space-y-3">
<label class="block text-lg font-bold text-blue-900">3. 结算信息</label>
<div class="flex items-center justify-between">
<span class="text-lg font-medium text-gray-700">是否郑老板货物？</span>
<label class="relative inline-flex items-center cursor-pointer">
<input class="sr-only peer" id="chkZhengBoss" onchange="toggleZhengMode()" type="checkbox"/>
<div class="w-14 h-7 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-blue-600"></div>
</label>
</div>
<div>
<label class="block text-gray-600 mb-1">货款价格 (元/吨)</label>
<div class="flex items-center bg-white rounded-lg border border-gray-300 px-3 py-2 focus-within:ring-2 focus-within:ring-blue-300 focus-within:border-blue-500">
<span class="text-2xl mr-2 text-gray-500">¥</span>
<input class="w-full text-2xl font-bold text-blue-800 outline-none bg-transparent" id="inpPrice" placeholder="0.00" step="0.01" type="number"/>
</div>
</div>
<!-- Zheng Boss Specifics -->
<div class="hidden bg-yellow-100 p-3 rounded border border-yellow-300 text-yellow-800 text-sm font-medium" id="zhengInfo">
<p><i class="fas fa-info-circle"></i> 郑老板模式：运费 = 50元/吨 × 净重</p>
</div>
</div>
<button class="w-full bg-green-600 text-white text-xl font-bold py-4 rounded-xl shadow-lg active:bg-green-700 transition-transform transform active:scale-95 flex items-center justify-center gap-2" onclick="saveRecord()">
<i class="fas fa-save"></i> 确认保存
                </button>
</div>
</section>
<!-- Page 2: Query -->
<section class="page-section p-4 hidden" id="page-query">
<header class="mb-4">
<h1 class="text-2xl font-bold text-gray-800">数据查询</h1>
</header>
<!-- Search & Filter -->
<div class="bg-white p-3 rounded-lg shadow-sm mb-4 flex gap-2">
<div class="flex-1 relative">
<i class="fas fa-search absolute left-3 top-3.5 text-gray-400"></i>
<input class="w-full bg-gray-100 rounded-lg pl-10 pr-4 py-2.5 text-lg outline-none focus:ring-2 focus:ring-blue-300" id="searchInput" oninput="renderRecords()" placeholder="搜索供应商、车牌..." type="text"/>
</div>
<button class="bg-gray-200 text-gray-700 px-4 rounded-lg font-medium active:bg-gray-300" onclick="toggleSelectAll()">全选</button>
</div>
<!-- Record List -->
<div class="space-y-3 pb-20" id="recordList">
<!-- Records injected here -->
<div class="text-center text-gray-400 mt-10 flex flex-col items-center">
<i class="fas fa-inbox text-4xl mb-2"></i>
<p>暂无数据</p>
</div>
</div>
<!-- Export Floating Button -->
<div class="fixed bottom-24 right-4 z-10">
<button class="bg-blue-600 text-white w-14 h-14 rounded-full shadow-xl flex items-center justify-center text-2xl active:scale-90 transition-transform border-4 border-blue-200" onclick="exportSelected()">
<i class="fas fa-download"></i>
</button>
</div>
</section>
<!-- Page 3: Prices -->
<section class="page-section p-4 hidden" id="page-prices">
<header class="mb-4 flex justify-between items-center">
<h1 class="text-2xl font-bold text-gray-800">货款价格表</h1>
<button class="bg-blue-600 text-white px-5 py-2 rounded-lg text-sm font-bold shadow active:bg-blue-700" onclick="savePrices()">保存更新</button>
</header>
<div class="bg-white rounded-xl shadow-sm overflow-hidden">
<table class="w-full text-left">
<thead class="bg-gray-100 text-gray-600 border-b border-gray-200">
<tr>
<th class="p-4 text-lg font-medium">燃料种类</th>
<th class="p-4 text-lg font-medium text-right">价格 (元/吨)</th>
</tr>
</thead>
<tbody class="divide-y divide-gray-100" id="priceTableBody">
<!-- Price rows injected here -->
</tbody>
</table>
</div>
</section>
<!-- Page 4: Credentials -->
<section class="page-section p-4 hidden" id="page-settings">
<header class="mb-6">
<h1 class="text-2xl font-bold text-gray-800">系统认证信息</h1>
<p class="text-gray-500 text-sm">百度智能云 OCR (只读)</p>
</header>
<div class="bg-white rounded-xl shadow-sm p-6 space-y-6">
<div>
<label class="block text-gray-500 text-sm mb-1 font-bold uppercase tracking-wider">APP ID</label>
<div class="bg-gray-100 p-4 rounded-lg font-mono text-lg break-all select-all border border-gray-200">122102244</div>
</div>
<div>
<label class="block text-gray-500 text-sm mb-1 font-bold uppercase tracking-wider">API Key</label>
<div class="bg-gray-100 p-4 rounded-lg font-mono text-lg break-all select-all border border-gray-200">NnrvJeOWeVcQ4vEdOWcT20q7</div>
</div>
<div>
<label class="block text-gray-500 text-sm mb-1 font-bold uppercase tracking-wider">Secret Key</label>
<div class="bg-gray-100 p-4 rounded-lg font-mono text-lg break-all select-all border border-gray-200">WuIokhwPmDXPgS1Viz8m1jaIaM7dlsUY</div>
</div>
</div>
<div class="mt-8 p-4 bg-yellow-50 rounded-lg border border-yellow-200 text-yellow-800 text-sm leading-relaxed">
<p><i class="fas fa-shield-alt mr-1"></i> <strong>注意：</strong> 认证信息已内置，用于首页OCR识别。请勿泄露给他人。</p>
</div>
</section>
</main>
<!-- Bottom Navigation -->
<nav class="fixed bottom-0 w-full bg-white border-t border-gray-200 flex justify-around items-center h-16 pb-safe z-20 shadow-[0_-2px_10px_rgba(0,0,0,0.05)]">
<button class="nav-btn active flex flex-col items-center justify-center w-full h-full text-blue-600 transition-colors" onclick="switchPage('home')">
<i class="fas fa-home text-xl mb-1"></i>
<span class="text-xs font-medium">首页</span>
</button>
<button class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400 transition-colors" onclick="switchPage('query')">
<i class="fas fa-search text-xl mb-1"></i>
<span class="text-xs font-medium">查询</span>
</button>
<button class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400 transition-colors" onclick="switchPage('prices')">
<i class="fas fa-tags text-xl mb-1"></i>
<span class="text-xs font-medium">价格</span>
</button>
<button class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400 transition-colors" onclick="switchPage('settings')">
<i class="fas fa-cog text-xl mb-1"></i>
<span class="text-xs font-medium">设置</span>
</button>
</nav>
<!-- Toast Container -->
<div class="fixed top-10 left-1/2 transform -translate-x-1/2 z-50 pointer-events-none w-full max-w-sm px-4" id="toastContainer"></div>
<!-- Hidden Export Container -->
<div class="fixed -left-[9999px] top-0 w-[800px] bg-white p-8 text-black font-sans" id="exportContainer">
<!-- Content for html2canvas -->
</div>
<script>
        // --- Configuration & Constants ---
        const BAIDU_OCR_CONFIG = {
            appId: '122102244',
            apiKey: 'NnrvJeOWeVcQ4vEdOWcT20q7',
            secretKey: 'WuIokhwPmDXPgS1Viz8m1jaIaM7dlsUY',
            tokenUrl: 'https://aip.baidubce.com/oauth/2.0/token',
            ocrUrl: 'https://aip.baidubce.com/rest/2.0/ocr/v1/accurate_basic'
        };

        const DEFAULT_PRICES = {
            "带叶薪柴三级": 270.00,
            "干树枝二级": 240.00,
            "干树枝一级": 298.00,
            "杉木树枝二级": 242.00,
            "杉木树枝一级": 202.00,
            "杨树皮二级": 247.00,
            "杨树皮一级": 180.00,
            "枝桠柴三级": 202.00,
            "竹枝": 222.00
        };

        const CURRENT_DATE = "2026-02-17"; // From prompt context

        // --- State Management ---
        let appState = {
            currentImage: null,
            ocrData: {},
            prices: JSON.parse(localStorage.getItem('cargo_prices')) || DEFAULT_PRICES,
            records: JSON.parse(localStorage.getItem('cargo_records')) || []
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            renderPriceTable();
            renderRecords();
            // Set default date
            document.getElementById('inpDate').value = CURRENT_DATE;
        });

        // --- Navigation ---
        function switchPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page-section').forEach(el => el.classList.add('hidden'));
            // Show target page
            document.getElementById(`page-${pageId}`).classList.remove('hidden');
            
            // Update Nav Icons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-blue-600');
                btn.classList.add('text-gray-400');
            });
            const activeBtn = document.querySelector(`.nav-btn[onclick="switchPage('${pageId}')"]`);
            activeBtn.classList.remove('text-gray-400');
            activeBtn.classList.add('text-blue-600');

            // Refresh data if needed
            if(pageId === 'query') renderRecords();
            if(pageId === 'prices') renderPriceTable();
        }

        // --- Toast Notification ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-gray-800' : 'bg-red-600';
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
            
            toast.className = `toast ${bgColor} text-white px-6 py-3 rounded-full shadow-lg mb-3 text-lg font-medium flex items-center justify-center gap-2`;
            toast.innerHTML = `<i class="fas ${icon}"></i> ${message}`;
            
            container.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('hiding');
                toast.addEventListener('animationend', () => toast.remove());
            }, 3000);
        }

        // --- OCR Logic ---
        function handleImageUpload(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    appState.currentImage = e.target.result;
                    document.getElementById('imagePreview').src = e.target.result;
                    document.getElementById('imagePreviewContainer').classList.remove('hidden');
                    document.getElementById('dataFormContainer').classList.add('hidden'); // Hide form until OCR done
                    performOCR(e.target.result);
                };
                reader.readAsDataURL(file);
            }
        }

        function clearImage() {
            appState.currentImage = null;
            document.getElementById('imagePreviewContainer').classList.add('hidden');
            document.getElementById('dataFormContainer').classList.add('hidden');
            document.getElementById('cameraInput').value = '';
            document.getElementById('albumInput').value = '';
        }

        async function performOCR(base64Image) {
            showToast('正在识别中...', 'success'); // Using toast for info
            
            // Remove Base64 header
            const imageBase64 = base64Image.replace(/^data:image\/(png|jpg|jpeg);base64,/, "");

            try {
                // 1. Get Token
                const tokenRes = await fetch(`${BAIDU_OCR_CONFIG.tokenUrl}?grant_type=client_credentials&client_id=${BAIDU_OCR_CONFIG.apiKey}&client_secret=${BAIDU_OCR_CONFIG.secretKey}`);
                const tokenData = await tokenRes.json();
                
                if (!tokenData.access_token) throw new Error("Token获取失败");

                // 2. Call OCR
                const formData = new FormData();
                formData.append('image', imageBase64);

                const ocrRes = await fetch(`${BAIDU_OCR_CONFIG.ocrUrl}?access_token=${tokenData.access_token}`, {
                    method: 'POST',
                    body: formData
                });
                
                const ocrData = await ocrRes.json();
                
                if (ocrData.error_code) {
                    throw new Error(`OCR Error: ${ocrData.error_msg}`);
                }

                processOCRResult(ocrData);

            } catch (error) {
                console.error("OCR Failed:", error);
                // Fallback for demo/CORS issues (Since static HTML cannot bypass CORS easily)
                showToast('网络请求受限，使用模拟数据演示', 'error');
                setTimeout(() => {
                    mockOCRProcess();
                }, 1000);
            }
        }

        function mockOCRProcess() {
            // Simulating the structure of Baidu response based on prompt samples
            const mockResponse = {
                words_result: [
                    { words: "临澧县凯迪绿色能源开发有限公司" },
                    { words: "燃料过磅单" },
                    { words: "供应商：安乡县顺清秸秆综合利用专业合作社" },
                    { words: "单号：2026021100100331" },
                    { words: "车牌号：湘J58217" },
                    { words: "燃料种类：枝桠柴三级" },
                    { words: "毛重(吨)：32.41" },
                    { words: "皮重(吨)：12.87" },
                    { words: "净重(吨)：19.54" },
                    { words: "扣杂质%：0.00" },
                    { words: "扣霉腐%：0.00" },
                    { words: "扣长杆%：0.00" }
                ]
            };
            processOCRResult(mockResponse);
        }

        function processOCRResult(data) {
            const text = data.words_result.map(item => item.words).join('\n');
            
            // Helper to find value after keyword
            const findVal = (regex) => {
                const match = text.match(regex);
                return match ? match[1] : '';
            };

            // Extract Data
            const supplier = findVal(/供应商[:：](.*)/);
            const fuelType = findVal(/燃料种类[:：](.*)/);
            const idNum = findVal(/单号[:：](\d{8})/);
            const plate = findVal(/车牌号[:：](.*)/);
            const gross = parseFloat(findVal(/毛重[（\(]吨[）\)][:：]\s*(\d+\.?\d*)/)) || 0;
            const tare = parseFloat(findVal(/皮重[（\(]吨[）\)][:：]\s*(\d+\.?\d*)/)) || 0;
            const net = parseFloat(findVal(/净重[（\(]吨[）\)][:：]\s*(\d+\.?\d*)/)) || 0;
            
            const impurity = parseFloat(findVal(/扣杂质%[:：]\s*(\d+\.?\d*)/)) || 0;
            const rot = parseFloat(findVal(/扣霉腐%[:：]\s*(\d+\.?\d*)/)) || 0;
            const longRod = parseFloat(findVal(/扣长杆%[:：]\s*(\d+\.?\d*)/)) || 0;
            const deductionRate = (impurity + rot + longRod);

            // Populate Form
            document.getElementById('inpSupplier').value = supplier.trim();
            document.getElementById('inpFuelType').value = fuelType.trim();
            document.getElementById('inpPlate').value = plate.trim();
            document.getElementById('inpDate').value = idNum ? `${idNum.substring(0,4)}-${idNum.substring(4,6)}-${idNum.substring(6,8)}` : CURRENT_DATE;
            
            document.getElementById('inpGross').value = gross.toFixed(2);
            document.getElementById('inpTare').value = tare.toFixed(2);
            document.getElementById('inpNet').value = net.toFixed(2);
            document.getElementById('inpDeduction').value = deductionRate.toFixed(2);

            // Auto-fill price based on fuel type if match found
            const matchedPrice = appState.prices[fuelType.trim()];
            if (matchedPrice) {
                document.getElementById('inpPrice').value = matchedPrice.toFixed(2);
            } else {
                document.getElementById('inpPrice').value = '';
            }

            // Show Form
            document.getElementById('dataFormContainer').classList.remove('hidden');
            showToast('识别成功，请核对');
        }

        // --- Calculation & Saving ---
        function toggleZhengMode() {
            const isZheng = document.getElementById('chkZhengBoss').checked;
            const info = document.getElementById('zhengInfo');
            if (isZheng) info.classList.remove('hidden');
            else info.classList.add('hidden');
        }

        function saveRecord() {
            // Gather Data
            const supplier = document.getElementById('inpSupplier').value;
            const fuelType = document.getElementById('inpFuelType').value;
            const date = document.getElementById('inpDate').value;
            const plate = document.getElementById('inpPlate').value;
            const deductionRate = parseFloat(document.getElementById('inpDeduction').value) || 0;
            const gross = parseFloat(document.getElementById('inpGross').value) || 0;
            const tare = parseFloat(document.getElementById('inpTare').value) || 0;
            const net = parseFloat(document.getElementById('inpNet').value) || 0;
            const inputPrice = parseFloat(document.getElementById('inpPrice').value) || 0;
            const isZheng = document.getElementById('chkZhengBoss').checked;

            if (!supplier || !fuelType || !inputPrice) {
                showToast('请填写完整信息', 'error');
                return;
            }

            // Calculations
            // 1. Effective Weight (Net * (1 - Deduction%))
            const effectiveWeight = net * (1 - deductionRate / 100);
            
            let payment = 0;
            let freight = 0;

            if (isZheng) {
                // Zheng Boss Logic
                freight = 50 * net; // Freight = 50 * NetWeight
                payment = effectiveWeight * (inputPrice - 50); // Price - (Freight/Net) = Price - 50
            } else {
                // Normal Logic
                payment = effectiveWeight * inputPrice;
            }

            // Return Price (Internal) = EffectiveWeight * TablePrice
            const tablePrice = appState.prices[fuelType] || 0;
            const returnPrice = effectiveWeight * tablePrice;

            const record = {
                id: Date.now(),
                supplier,
                fuelType,
                date,
                plate,
                deductionRate,
                gross,
                tare,
                net,
                inputPrice,
                isZheng,
                payment: payment.toFixed(2),
                freight: freight.toFixed(2),
                returnPrice: returnPrice.toFixed(2),
                image: appState.currentImage // Store base64
            };

            // Save
            appState.records.unshift(record);
            localStorage.setItem('cargo_records', JSON.stringify(appState.records));

            // Reset
            clearImage();
            document.getElementById('dataFormContainer').classList.add('hidden');
            document.getElementById('chkZhengBoss').checked = false;
            toggleZhengMode();
            
            showToast('保存成功');
        }

        // --- Query & Export ---
        function renderRecords() {
            const list = document.getElementById('recordList');
            const filter = document.getElementById('searchInput').value.toLowerCase();
            list.innerHTML = '';

            const filtered = appState.records.filter(r => 
                r.supplier.toLowerCase().includes(filter) || 
                r.plate.toLowerCase().includes(filter) ||
                r.fuelType.toLowerCase().includes(filter)
            );

            if (filtered.length === 0) {
                list.innerHTML = `
                <div class="text-center text-gray-400 mt-10 flex flex-col items-center">
                    <i class="fas fa-inbox text-4xl mb-2"></i>
                    <p>暂无数据</p>
                </div>`;
                return;
            }

            filtered.forEach(r => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-xl shadow-sm border border-gray-100';
                
                // Calculation Formula String
                let formulaStr = `付款 = ${r.net}×(1-${r.deductionRate}%)×${r.inputPrice}`;
                if (r.isZheng) {
                    formulaStr = `付款 = ${r.net}×(1-${r.deductionRate}%)×(${r.inputPrice}-50)`;
                }

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h3 class="font-bold text-lg text-gray-800">${r.supplier}</h3>
                            <p class="text-sm text-gray-500">${r.date} | ${r.plate}</p>
                        </div>
                        <div class="text-right">
                            <div class="text-xl font-bold text-blue-600">¥${r.payment}</div>
                            ${r.isZheng ? `<div class="text-xs text-orange-500 font-bold">含运费 ¥${r.freight}</div>` : ''}
                        </div>
                    </div>
                    <div class="flex justify-between items-center mt-2 pt-2 border-t border-gray-100">
                        <span class="text-sm bg-gray-100 px-2 py-1 rounded text-gray-600">${r.fuelType}</span>
                        <div class="flex items-center gap-2">
                            <span class="text-green-600 font-bold text-sm bg-green-50 px-2 py-1 rounded">回款: ¥${r.returnPrice}</span>
                            <input type="checkbox" class="record-check w-5 h-5 text-blue-600 rounded focus:ring-blue-500 cursor-pointer" value="${r.id}">
                        </div>
                    </div>
                    <div class="text-xs text-gray-400 mt-2 font-mono truncate bg-gray-50 p-1 rounded">${formulaStr}</div>
                `;
                list.appendChild(card);
            });
        }

        function toggleSelectAll() {
            const checks = document.querySelectorAll('.record-check');
            const allChecked = Array.from(checks).every(c => c.checked);
            checks.forEach(c => c.checked = !allChecked);
        }

        function exportSelected() {
            const checks = document.querySelectorAll('.record-check:checked');
            if (checks.length === 0) {
                showToast('请先选择要导出的数据', 'error');
                return;
            }

            const container = document.getElementById('exportContainer');
            container.innerHTML = ''; // Clear previous

            checks.forEach(check => {
                const r = appState.records.find(rec => rec.id == check.value);
                if (!r) return;

                const item = document.createElement('div');
                item.className = 'border-b-2 border-black pb-4 mb-4 break-inside-avoid';
                
                let formulaStr = `付款 = ${r.net}×(1-${r.deductionRate}%)×${r.inputPrice}`;
                if (r.isZheng) {
                    formulaStr = `付款 = ${r.net}×(1-${r.deductionRate}%)×(${r.inputPrice}-50)`;
                }

                item.innerHTML = `
                    <div class="text-center font-bold text-2xl mb-4 border-b border-gray-300 pb-2">货物交付单</div>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-lg mb-4">
                        <div><strong>供应商:</strong> ${r.supplier}</div>
                        <div><strong>日期:</strong> ${r.date}</div>
                        <div><strong>燃料种类:</strong> ${r.fuelType}</div>
                        <div><strong>车牌号:</strong> ${r.plate}</div>
                        <div><strong>净重:</strong> ${r.net}吨</div>
                        <div><strong>扣除率:</strong> ${r.deductionRate}%</div>
                        <div><strong>货款单价:</strong> ${r.inputPrice}元/吨</div>
                    </div>
                    <div class="bg-gray-100 p-3 rounded text-base mb-4 font-mono text-gray-700">
                        <strong>计算方式:</strong> ${formulaStr}
                    </div>
                    <div class="text-right mt-4 pt-4 border-t border-dashed border-gray-400">
                        <div class="text-3xl font-bold text-gray-900">付款总额: ¥${r.payment}</div>
                        ${r.isZheng ? `<div class="text-xl text-orange-600 font-bold mt-1">运费: ¥${r.freight}</div>` : ''}
                    </div>
                `;
                container.appendChild(item);
            });

            // Use html2canvas
            html2canvas(container, { scale: 2, useCORS: true }).then(canvas => {
                const link = document.createElement('a');
                link.download = `货物交付单_${new Date().toISOString().slice(0,10)}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                showToast('导出成功');
            }).catch(err => {
                console.error(err);
                showToast('导出失败', 'error');
            });
        }

        // --- Price Management ---
        function renderPriceTable() {
            const tbody = document.getElementById('priceTableBody');
            tbody.innerHTML = '';
            for (const [name, price] of Object.entries(appState.prices)) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-4 text-lg font-medium text-gray-700">${name}</td>
                    <td class="p-4 text-right">
                        <div class="flex items-center justify-end">
                            <span class="mr-1 text-gray-500">¥</span>
                            <input type="number" step="0.01" value="${price}" 
                                onchange="updatePrice('${name}', this.value)"
                                class="w-28 text-right border-b border-gray-300 focus:border-blue-500 outline-none text-lg font-bold bg-transparent">
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            }
        }

        function updatePrice(name, value) {
            appState.prices[name] = parseFloat(value) || 0;
        }

        function savePrices() {
            localStorage.setItem('cargo_prices', JSON.stringify(appState.prices));
            showToast('价格表已更新');
        }
    </script>
</body>
</html>