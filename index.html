<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<title>燃料过磅单处理系统</title>
<script src="https://image.uc.cn/s/uae/g/3n/mos-production/0915/3.4.17.js"></script>
<script src="https://image.uc.cn/s/uae/g/3n/mos-production/fontawesome-free-7.1.0-web/js/all.min.js"></script>
<link href="https://image.uc.cn/s/uae/g/3n/mos-production/fontawesome-free-7.1.0-web/css/fontawesome.min.css" rel="stylesheet"/>
<script src="https://image.uc.cn/s/uae/g/3n/mos-production/cdn-staticfile-net/axios/1.6.7/axios.min.js"></script>
<style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f3f4f6; padding-bottom: 80px; font-size: 16px; }
    input, select, textarea { font-size: 16px !important; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 50; left: 50%; top: 30px; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s, top 0.3s; }
    #toast.show { visibility: visible; opacity: 1; top: 50px; }
    #exportCanvas { display: none; }
    .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 8px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body>

<div id="toast">操作成功</div>

<main class="p-4 max-w-4xl mx-auto">
    <!-- PAGE 1: INDEX (Home / OCR) -->
    <section class="page-section" id="page-home">
        <h2 class="text-2xl font-bold mb-4 text-gray-800 border-l-4 border-blue-500 pl-3">过磅单识别</h2>
        
        <div class="bg-white p-4 rounded-lg shadow mb-6">
            <label class="block text-gray-700 font-bold mb-2">上传过磅单图片</label>
            <div class="flex gap-2">
                <label class="flex-1 bg-blue-600 text-white text-center py-3 rounded-lg cursor-pointer hover:bg-blue-700 transition">
                    <i class="fas fa-camera mr-2"></i>拍照
                    <input accept="image/*" capture="environment" class="hidden" id="cameraInput" onchange="handleImageUpload(this)" type="file"/>
                </label>
                <label class="flex-1 bg-green-600 text-white text-center py-3 rounded-lg cursor-pointer hover:bg-green-700 transition">
                    <i class="fas fa-image mr-2"></i>相册
                    <input accept="image/*" class="hidden" id="galleryInput" onchange="handleImageUpload(this)" type="file"/>
                </label>
            </div>
            <div class="mt-4 hidden" id="imagePreviewContainer">
                <img alt="预览" class="w-full h-48 object-contain bg-gray-100 rounded border" id="imagePreview"/>
                <div id="ocrStatus" class="text-sm text-blue-600 mt-2 text-center font-bold hidden">
                    <div class="loader"></div> 正在识别中...
                </div>
            </div>
        </div>

        <div class="bg-white p-4 rounded-lg shadow mb-6">
            <h3 class="text-lg font-bold mb-3 text-gray-700">识别结果核对</h3>
            <form class="space-y-3" id="ocrForm">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-600">供应商</label>
                        <input class="w-full border rounded p-2 bg-gray-50" id="supplier" placeholder="自动识别" type="text"/>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600">车牌号</label>
                        <input class="w-full border rounded p-2 bg-gray-50" id="plateNumber" placeholder="自动识别" type="text"/>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-600">燃料种类</label>
                        <input class="w-full border rounded p-2 bg-gray-50" id="fuelType" list="fuelTypeList" type="text"/>
                        <datalist id="fuelTypeList"></datalist>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600">日期</label>
                        <input class="w-full border rounded p-2 bg-gray-50" id="date" type="date"/>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-600">毛重 (吨)</label>
                        <input class="w-full border rounded p-2 bg-gray-50" id="grossWeight" onchange="calculateNetWeight()" step="0.01" type="number"/>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600">皮重 (吨)</label>
                        <input class="w-full border rounded p-2 bg-gray-50" id="tareWeight" onchange="calculateNetWeight()" step="0.01" type="number"/>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600">净重 (吨)</label>
                        <input class="w-full border rounded p-2 bg-blue-50 font-bold text-blue-800" id="netWeight" readonly="" step="0.01" type="number"/>
                    </div>
                </div>
                <div class="bg-gray-50 p-3 rounded border">
                    <label class="block text-sm font-bold text-gray-700 mb-2">货物扣除率 (%)</label>
                    <div class="grid grid-cols-3 gap-2">
                        <div>
                            <label class="text-xs text-gray-500">杂质</label>
                            <input class="w-full border rounded p-1 text-sm" id="deductImpurity" onchange="calculateDeduction()" step="0.01" type="number" value="0.00"/>
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">霉腐</label>
                            <input class="w-full border rounded p-1 text-sm" id="deductRot" onchange="calculateDeduction()" step="0.01" type="number" value="0.00"/>
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">长杆</label>
                            <input class="w-full border rounded p-1 text-sm" id="deductLong" onchange="calculateDeduction()" step="0.01" type="number" value="0.00"/>
                        </div>
                    </div>
                    <div class="mt-2 flex justify-between items-center">
                        <span class="text-sm text-gray-600">扣后重量:</span>
                        <span class="font-bold text-lg" id="finalWeightDisplay">0.00</span> 吨
                    </div>
                </div>
                <div class="border-t pt-3 mt-3">
                    <div class="flex items-center mb-3">
                        <input class="w-5 h-5 text-blue-600 rounded mr-2" id="isZhengBoss" onchange="updateCalculations()" type="checkbox"/>
                        <label class="text-lg font-bold text-gray-800" for="isZhengBoss">是否为郑老板的货物？</label>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600">本次货款价格 (元/吨) <span class="text-red-500">*</span></label>
                        <input class="w-full border rounded p-2 bg-yellow-50 text-lg font-bold" id="userPrice" oninput="updateCalculations()" placeholder="输入价格" step="0.01" type="number"/>
                    </div>
                    <div class="mt-4 bg-blue-50 p-3 rounded border border-blue-100">
                        <div class="flex justify-between mb-1">
                            <span class="text-gray-600">运费 (郑老板):</span>
                            <span class="font-bold" id="freightDisplay">0.00</span> 元
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-800 font-bold text-lg">付款总额:</span>
                            <span class="font-bold text-xl text-blue-700" id="totalPaymentDisplay">0.00</span> 元
                        </div>
                    </div>
                </div>
                <button class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg mt-4 shadow hover:bg-blue-700 active:bg-blue-800 transition" onclick="saveRecord()" type="button">
                    <i class="fas fa-save mr-2"></i>确认保存
                </button>
            </form>
        </div>
    </section>

    <!-- PAGE 2: QUERY (增加供应商筛选) -->
    <section class="page-section hidden" id="page-query">
        <h2 class="text-2xl font-bold mb-4 text-gray-800 border-l-4 border-green-500 pl-3">数据查询</h2>
        <div class="bg-white p-3 rounded-lg shadow mb-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                <input class="border rounded p-2" id="filterDate" onchange="renderRecords()" type="date"/>
                <select class="border rounded p-2" id="filterFuel" onchange="renderRecords()">
                    <option value="">所有燃料</option>
                </select>
                <input class="border rounded p-2" id="filterSupplier" placeholder="搜索供应商..." oninput="renderRecords()"/>
            </div>
        </div>
        <div class="space-y-4" id="recordsList">
            <div class="text-center text-gray-400 mt-10">暂无数据</div>
        </div>
    </section>

    <!-- PAGE 3: PRICE -->
    <section class="page-section hidden" id="page-price">
        <h2 class="text-2xl font-bold mb-4 text-gray-800 border-l-4 border-yellow-500 pl-3">货款价格管理</h2>
        <div class="bg-white p-4 rounded-lg shadow mb-6">
            <h3 class="text-lg font-bold mb-3">添加/更新价格</h3>
            <div class="flex gap-2">
                <input class="border rounded p-2 flex-2" id="newPriceName" placeholder="燃料种类名称" type="text"/>
                <input class="border rounded p-2 flex-1" id="newPriceValue" placeholder="价格" step="0.01" type="number"/>
                <button class="bg-yellow-500 text-white px-4 rounded font-bold hover:bg-yellow-600" onclick="addOrUpdatePrice()">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <table class="w-full text-left border-collapse">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="p-3 border-b">燃料种类</th>
                        <th class="p-3 border-b">价格 (元/吨)</th>
                        <th class="p-3 border-b text-right">操作</th>
                    </tr>
                </thead>
                <tbody id="priceListBody"></tbody>
            </table>
        </div>
    </section>

    <!-- PAGE 4: AUTH -->
    <section class="page-section hidden" id="page-auth">
        <h2 class="text-2xl font-bold mb-4 text-gray-800 border-l-4 border-purple-500 pl-3">认证信息</h2>
        <div class="bg-white p-6 rounded-lg shadow">
            <div class="mb-6">
                <label class="block text-gray-500 text-sm font-bold mb-2">App ID</label>
                <div class="text-2xl font-mono bg-gray-100 p-3 rounded break-all">122102244</div>
            </div>
            <div class="mb-6">
                <label class="block text-gray-500 text-sm font-bold mb-2">API Key</label>
                <div class="text-xl font-mono bg-gray-100 p-3 rounded break-all text-blue-700">NnrvJeOWeVcQ4vEdOWcT20q7</div>
            </div>
            <div class="mb-6">
                <label class="block text-gray-500 text-sm font-bold mb-2">Secret Key</label>
                <div class="text-xl font-mono bg-gray-100 p-3 rounded break-all text-red-700">WuIokhwPmDXPgS1Viz8m1jaIaM7dlsUY</div>
            </div>
            <div class="text-center text-gray-400 text-sm mt-8">
                <i class="fas fa-lock"></i> 信息仅供查看，不可修改
            </div>
        </div>
    </section>
</main>

<nav class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 shadow-lg z-40">
    <div class="flex justify-around items-center h-16">
        <button class="nav-btn flex-1 flex flex-col items-center justify-center text-blue-600" data-target="home" onclick="navTo('home')">
            <i class="fas fa-camera text-xl mb-1"></i>
            <span class="text-xs font-bold">识别</span>
        </button>
        <button class="nav-btn flex-1 flex flex-col items-center justify-center text-gray-500" data-target="query" onclick="navTo('query')">
            <i class="fas fa-list-alt text-xl mb-1"></i>
            <span class="text-xs font-bold">查询</span>
        </button>
        <button class="nav-btn flex-1 flex flex-col items-center justify-center text-gray-500" data-target="price" onclick="navTo('price')">
            <i class="fas fa-tags text-xl mb-1"></i>
            <span class="text-xs font-bold">价格</span>
        </button>
        <button class="nav-btn flex-1 flex flex-col items-center justify-center text-gray-500" data-target="auth" onclick="navTo('auth')">
            <i class="fas fa-key text-xl mb-1"></i>
            <span class="text-xs font-bold">认证</span>
        </button>
    </div>
</nav>

<canvas id="exportCanvas"></canvas>

<script>
    // ================= 配置区 =================
    const WORKER_URL = 'https://baidu-ocr-proxy.luzer244.workers.dev/?url=';
    
    const BAIDU_CONFIG = {
        apiKey: 'NnrvJeOWeVcQ4vEdOWcT20q7',
        secretKey: 'WuIokhwPmDXPgS1Viz8m1jaIaM7dlsUY',
        tokenUrl: 'https://aip.baidubce.com/oauth/2.0/token'
    };

    const DEFAULT_PRICES = [
        { name: "带叶薪柴三级", price: 270.00 },
        { name: "干树枝二级", price: 240.00 },
        { name: "干树枝一级", price: 298.00 },
        { name: "杉木树枝二级", price: 242.00 },
        { name: "杉木树枝一级", price: 202.00 },
        { name: "杨树皮二级", price: 247.00 },
        { name: "杨树皮一级", price: 180.00 },
        { name: "枝桠柴三级", price: 202.00 },
        { name: "竹枝", price: 222.00 }
    ];

    let appState = {
        accessToken: localStorage.getItem('baidu_token') || null,
        tokenExpiry: localStorage.getItem('baidu_token_expiry') || 0,
        prices: JSON.parse(localStorage.getItem('fuel_prices')) || DEFAULT_PRICES,
        records: JSON.parse(localStorage.getItem('weighbridge_records')) || []
    };

    document.addEventListener('DOMContentLoaded', () => {
        initPrices();
        populateFuelDatalist();
        setTodayDate();
    });

    function showToast(message) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.className = "show";
        setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
    }

    function navTo(pageId) {
        document.querySelectorAll('.page-section').forEach(el => el.classList.add('hidden'));
        document.getElementById(`page-${pageId}`).classList.remove('hidden');
        document.querySelectorAll('.nav-btn').forEach(btn => {
            if(btn.dataset.target === pageId) {
                btn.classList.add('text-blue-600');
                btn.classList.remove('text-gray-500');
            } else {
                btn.classList.remove('text-blue-600');
                btn.classList.add('text-gray-500');
            }
        });
        if(pageId === 'query') renderRecords();
        if(pageId === 'price') renderPriceList();
    }

    function initPrices() {
        if (!localStorage.getItem('fuel_prices')) {
            localStorage.setItem('fuel_prices', JSON.stringify(DEFAULT_PRICES));
        }
    }

    function populateFuelDatalist() {
        const list = document.getElementById('fuelTypeList');
        const filter = document.getElementById('filterFuel');
        list.innerHTML = '';
        filter.innerHTML = '<option value="">所有燃料</option>';
        appState.prices.forEach(p => {
            const option = document.createElement('option');
            option.value = p.name;
            list.appendChild(option);
            const filterOption = document.createElement('option');
            filterOption.value = p.name;
            filter.appendChild(filterOption);
        });
    }

    function renderPriceList() {
        const tbody = document.getElementById('priceListBody');
        tbody.innerHTML = '';
        appState.prices.forEach((p, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="p-3 border-b">${p.name}</td>
                <td class="p-3 border-b font-mono">${parseFloat(p.price).toFixed(2)}</td>
                <td class="p-3 border-b text-right">
                    <button onclick="deletePrice(${index})" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function addOrUpdatePrice() {
        const name = document.getElementById('newPriceName').value.trim();
        const price = parseFloat(document.getElementById('newPriceValue').value);
        if (!name || isNaN(price)) {
            showToast("请输入有效的名称和价格");
            return;
        }
        const existingIndex = appState.prices.findIndex(p => p.name === name);
        if (existingIndex >= 0) {
            appState.prices[existingIndex].price = price;
            showToast("价格已更新");
        } else {
            appState.prices.push({ name, price });
            showToast("新价格已添加");
        }
        localStorage.setItem('fuel_prices', JSON.stringify(appState.prices));
        document.getElementById('newPriceName').value = '';
        document.getElementById('newPriceValue').value = '';
        renderPriceList();
        populateFuelDatalist();
    }

    function deletePrice(index) {
        if(confirm("确定删除此价格条目吗？")) {
            appState.prices.splice(index, 1);
            localStorage.setItem('fuel_prices', JSON.stringify(appState.prices));
            renderPriceList();
            populateFuelDatalist();
        }
    }

    // ================= OCR 核心逻辑 =================
    
    async function getAccessToken() {
        const now = Date.now();
        if (appState.accessToken && now < appState.tokenExpiry) {
            return appState.accessToken;
        }
        const url = `${BAIDU_CONFIG.tokenUrl}?grant_type=client_credentials&client_id=${BAIDU_CONFIG.apiKey}&client_secret=${BAIDU_CONFIG.secretKey}`;
        try {
            const response = await fetch(WORKER_URL + encodeURIComponent(url));
            const data = await response.json();
            if(data.access_token) {
                appState.accessToken = data.access_token;
                appState.tokenExpiry = now + (data.expires_in - 300) * 1000;
                localStorage.setItem('baidu_token', appState.accessToken);
                localStorage.setItem('baidu_token_expiry', appState.tokenExpiry);
                return appState.accessToken;
            }
            throw new Error('Token 获取失败');
        } catch (error) {
            console.error("Token Error:", error);
            showToast("获取认证失败");
            return null;
        }
    }

    function handleImageUpload(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('imagePreview').src = e.target.result;
                document.getElementById('imagePreviewContainer').classList.remove('hidden');
                document.getElementById('ocrStatus').classList.remove('hidden');
                performOCR(e.target.result.split(',')[1]);
            }
            reader.readAsDataURL(file);
        }
    }

    async function performOCR(base64Image) {
        const token = await getAccessToken();
        if (!token) {
            document.getElementById('ocrStatus').classList.add('hidden');
            return;
        }

        const ocrUrl = `https://aip.baidubce.com/rest/2.0/ocr/v1/accurate_basic?access_token=${token}`;
        
        try {
            const response = await fetch(WORKER_URL + encodeURIComponent(ocrUrl), {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `image=${encodeURIComponent(base64Image)}`
            });

            if (!response.ok) throw new Error('网络响应异常');
            
            const data = await response.json();
            
            if(data.error_code) {
                throw new Error(data.error_msg || '识别失败');
            }

            parseOCRResults(data.words_result);
            document.getElementById('ocrStatus').innerHTML = '<i class="fas fa-check-circle text-green-500"></i> 识别完成';
            setTimeout(() => document.getElementById('ocrStatus').classList.add('hidden'), 2000);
            showToast("识别成功，请核对");

        } catch (error) {
            console.error("OCR Error:", error);
            document.getElementById('ocrStatus').innerHTML = '<i class="fas fa-times-circle text-red-500"></i> 识别失败';
            showToast("识别失败，请重试或手动输入");
        }
    }

    // ================= 增强版解析逻辑 (修复车牌和日期) =================
    function parseOCRResults(wordsResult) {
        let fullText = wordsResult.map(item => item.words).join('\n');
        console.log('完整识别文本:', fullText);
        
        // 1. 日期 - 多种格式匹配
        let dateStr = "";
        
        // 方法 1: 从单号提取 (YYYYMMDD)
        const serialMatch = fullText.match(/单号 [:：]?\s*(\d{8,14})/);
        if (serialMatch && serialMatch[1]) {
            const d = serialMatch[1].substring(0, 8);
            dateStr = `${d.substring(0,4)}-${d.substring(4,6)}-${d.substring(6,8)}`;
        }
        
        // 方法 2: 直接找日期格式 (YYYY-MM-DD 或 YYYY/MM/DD)
        if (!dateStr) {
            const dateMatch = fullText.match(/(\d{4})[-/](\d{1,2})[-/](\d{1,2})/);
            if (dateMatch) {
                dateStr = `${dateMatch[1]}-${dateMatch[2].padStart(2,'0')}-${dateMatch[3].padStart(2,'0')}`;
            }
        }
        
        // 方法 3: 找"年"字格式
        if (!dateStr) {
            const yearMatch = fullText.match(/(\d{4}) 年 (\d{1,2}) 月 (\d{1,2}) 日/);
            if (yearMatch) {
                dateStr = `${yearMatch[1]}-${yearMatch[2].padStart(2,'0')}-${yearMatch[3].padStart(2,'0')}`;
            }
        }
        
        // 如果都没找到，用今天
        if (!dateStr) {
            setTodayDate();
        } else {
            document.getElementById('date').value = dateStr;
        }
        console.log('解析日期:', dateStr);

        // 2. 供应商 - 彻底清理
        let supplierText = "";
        for (let item of wordsResult) {
            const text = item.words.trim();
            if (text.includes('供应商')) {
                // 按冒号分割
                if(text.includes(':') || text.includes('：')) {
                    const parts = text.split(/[:：]/);
                    supplierText = parts[parts.length - 1].trim();
                } else {
                    supplierText = text.replace('供应商', '').trim();
                }
                // 清理所有标点
                supplierText = supplierText.replace(/[:：\s]+/g, ' ').trim();
                break;
            }
        }
        document.getElementById('supplier').value = supplierText;
        console.log('解析供应商:', supplierText);

        // 3. 车牌号 - 增强匹配
        let plate = "";
        
        // 方法 1: 找"车牌"关键词所在行
        for (let item of wordsResult) {
            const text = item.words.trim();
            if (text.includes('车牌') || text.includes('车号')) {
                // 匹配湘 J 开头的车牌
                const m = text.match(/湘 [A-Z][A-Z0-9]{4,6}/);
                if(m) {
                    plate = m[0];
                    break;
                }
                // 匹配任意省份车牌
                const m2 = text.match(/[京津沪渝冀豫云辽黑湘皖鲁新苏浙赣鄂桂甘晋蒙陕吉闽贵粤青藏川宁琼][A-Z][A-Z0-9]{4,6}/);
                if(m2) {
                    plate = m2[0];
                    break;
                }
            }
        }
        
        // 方法 2: 全文搜索车牌号
        if(!plate) {
            const plateMatch = fullText.match(/湘 [A-Z][A-Z0-9]{4,6}/);
            if(plateMatch) {
                plate = plateMatch[0];
            }
        }
        
        document.getElementById('plateNumber').value = plate;
        console.log('解析车牌:', plate);
        
        // 4. 重量
        const findNumber = (keyword) => {
            for (let item of wordsResult) {
                if (item.words.includes(keyword)) {
                    const nums = item.words.match(/(\d+\.?\d*)/g);
                    if(nums && nums.length > 0) {
                        return nums[nums.length - 1];
                    }
                }
            }
            return "";
        };
        
        const gross = findNumber("毛重");
        const tare = findNumber("皮重");
        const net = findNumber("净重");
        
        if(gross) document.getElementById('grossWeight').value = parseFloat(gross).toFixed(2);
        if(tare) document.getElementById('tareWeight').value = parseFloat(tare).toFixed(2);
        if(net) document.getElementById('netWeight').value = parseFloat(net).toFixed(2);

        // 5. 扣杂
        const impurity = findNumber("杂质") || findNumber("扣杂");
        const rot = findNumber("霉腐") || findNumber("扣霉");
        const long = findNumber("长杆") || findNumber("扣长");
        
        if(impurity) document.getElementById('deductImpurity').value = parseFloat(impurity).toFixed(2);
        if(rot) document.getElementById('deductRot').value = parseFloat(rot).toFixed(2);
        if(long) document.getElementById('deductLong').value = parseFloat(long).toFixed(2);

        // 6. 燃料种类
        const foundFuel = appState.prices.find(p => fullText.includes(p.name));
        if(foundFuel) {
            document.getElementById('fuelType').value = foundFuel.name;
        } else {
            const lines = fullText.split('\n');
            for(let line of lines) {
                if(line.includes("燃料") || line.includes("品名")) {
                     document.getElementById('fuelType').value = line.replace(/燃料 | 品名|[:：]/g, "").trim();
                     break;
                }
            }
        }

        // 触发计算
        calculateNetWeight();
        calculateDeduction();
    }

    // ================= 计算逻辑 =================
    function setTodayDate() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date').value = today;
    }

    function calculateNetWeight() {
        const gross = parseFloat(document.getElementById('grossWeight').value) || 0;
        const tare = parseFloat(document.getElementById('tareWeight').value) || 0;
        const net = gross - tare;
        document.getElementById('netWeight').value = net.toFixed(2);
        calculateDeduction();
        updateCalculations();
    }

    function calculateDeduction() {
        const net = parseFloat(document.getElementById('netWeight').value) || 0;
        const pImp = parseFloat(document.getElementById('deductImpurity').value) || 0;
        const pRot = parseFloat(document.getElementById('deductRot').value) || 0;
        const pLong = parseFloat(document.getElementById('deductLong').value) || 0;
        const totalDeductionRate = pImp + pRot + pLong;
        const deductionWeight = net * (totalDeductionRate / 100);
        const finalWeight = net - deductionWeight;
        document.getElementById('finalWeightDisplay').innerText = finalWeight.toFixed(2);
        updateCalculations();
        return finalWeight.toFixed(2);
    }

    function updateCalculations() {
        const isZheng = document.getElementById('isZhengBoss').checked;
        const net = parseFloat(document.getElementById('netWeight').value) || 0;
        const finalWeight = parseFloat(document.getElementById('finalWeightDisplay').innerText) || 0;
        const userPrice = parseFloat(document.getElementById('userPrice').value) || 0;
        let freight = 0;
        if (isZheng) {
            freight = 50 * net;
        }
        const totalPayment = (finalWeight * userPrice) - freight;
        document.getElementById('freightDisplay').innerText = freight.toFixed(2);
        document.getElementById('totalPaymentDisplay').innerText = totalPayment.toFixed(2);
    }

    function saveRecord() {
        const userPrice = parseFloat(document.getElementById('userPrice').value);
        if (isNaN(userPrice)) {
            showToast("请输入货款价格");
            return;
        }
        const record = {
            id: Date.now(),
            supplier: document.getElementById('supplier').value,
            fuelType: document.getElementById('fuelType').value,
            date: document.getElementById('date').value,
            plateNumber: document.getElementById('plateNumber').value,
            grossWeight: parseFloat(document.getElementById('grossWeight').value).toFixed(2),
            tareWeight: parseFloat(document.getElementById('tareWeight').value).toFixed(2),
            netWeight: parseFloat(document.getElementById('netWeight').value).toFixed(2),
            deductImpurity: parseFloat(document.getElementById('deductImpurity').value).toFixed(2),
            deductRot: parseFloat(document.getElementById('deductRot').value).toFixed(2),
            deductLong: parseFloat(document.getElementById('deductLong').value).toFixed(2),
            finalWeight: document.getElementById('finalWeightDisplay').innerText,
            userPrice: userPrice.toFixed(2),
            isZhengBoss: document.getElementById('isZhengBoss').checked,
            freight: document.getElementById('freightDisplay').innerText,
            totalPayment: document.getElementById('totalPaymentDisplay').innerText
        };
        const priceObj = appState.prices.find(p => p.name === record.fuelType);
        const standardPrice = priceObj ? priceObj.price : 0;
        record.repayment = (parseFloat(record.finalWeight) * standardPrice).toFixed(2);
        appState.records.unshift(record);
        localStorage.setItem('weighbridge_records', JSON.stringify(appState.records));
        
        document.getElementById('ocrForm').reset();
        document.getElementById('imagePreviewContainer').classList.add('hidden');
        document.getElementById('finalWeightDisplay').innerText = "0.00";
        document.getElementById('freightDisplay').innerText = "0.00";
        document.getElementById('totalPaymentDisplay').innerText = "0.00";
        setTodayDate();
        
        showToast("保存成功");
    }

    // ================= 查询功能 (增加供应商筛选) =================
    function renderRecords() {
        const container = document.getElementById('recordsList');
        const filterDate = document.getElementById('filterDate').value;
        const filterFuel = document.getElementById('filterFuel').value;
        const filterSupplier = document.getElementById('filterSupplier').value.trim().toLowerCase();
        
        container.innerHTML = '';
        
        const filtered = appState.records.filter(r => {
            const matchDate = !filterDate || r.date === filterDate;
            const matchFuel = !filterFuel || r.fuelType === filterFuel;
            const matchSupplier = !filterSupplier || (r.supplier && r.supplier.toLowerCase().includes(filterSupplier));
            return matchDate && matchFuel && matchSupplier;
        });
        
        if (filtered.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-400 mt-10">暂无匹配数据</div>';
            return;
        }
        
        filtered.forEach(r => {
            const card = document.createElement('div');
            card.className = "bg-white p-4 rounded-lg shadow border-l-4 border-gray-300";
            const repaymentColor = "text-green-600 font-bold";
            let deductions = [];
            if(parseFloat(r.deductImpurity) > 0) deductions.push(`杂${r.deductImpurity}%`);
            if(parseFloat(r.deductRot) > 0) deductions.push(`霉${r.deductRot}%`);
            if(parseFloat(r.deductLong) > 0) deductions.push(`长${r.deductLong}%`);
            const deductionStr = deductions.length > 0 ? deductions.join(', ') : "无";
            card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h3 class="font-bold text-lg">${r.date} <span class="text-sm font-normal text-gray-500">${r.fuelType}</span></h3>
                        <p class="text-sm text-gray-600">${r.supplier} | ${r.plateNumber}</p>
                    </div>
                    <div class="text-right">
                         <div class="text-xs text-gray-500">净重：${r.netWeight}吨</div>
                         <div class="text-xs text-gray-500">扣后：${r.finalWeight}吨</div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2 text-sm bg-gray-50 p-2 rounded mb-2">
                    <div>扣除率：${deductionStr}</div>
                    <div>单价：${r.userPrice}元</div>
                    <div>付款总额：<span class="font-bold text-blue-700">${r.totalPayment}元</span></div>
                    <div class="${repaymentColor}">回款：${r.repayment}元</div>
                    ${r.isZhengBoss ? `<div class="col-span-2 text-red-500 text-xs">含运费：${r.freight}元 (郑老板)</div>` : ''}
                </div>
                <div class="flex justify-end gap-2 mt-2">
                    <button onclick="exportRecord(${r.id})" class="bg-gray-200 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-300">
                        <i class="fas fa-image mr-1"></i>导出图片
                    </button>
                    <button onclick="deleteRecord(${r.id})" class="bg-red-100 text-red-600 px-3 py-1 rounded text-sm hover:bg-red-200">
                        <i class="fas fa-trash mr-1"></i>删除
                    </button>
                </div>
            `;
            container.appendChild(card);
        });
    }

    function deleteRecord(id) {
        if(confirm("确定删除此条记录吗？")) {
            appState.records = appState.records.filter(r => r.id !== id);
            localStorage.setItem('weighbridge_records', JSON.stringify(appState.records));
            renderRecords();
            showToast("已删除");
        }
    }

    function exportRecord(id) {
        const r = appState.records.find(rec => rec.id === id);
        if (!r) return;
        const canvas = document.getElementById('exportCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 800;
        canvas.height = 600;
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#000000";
        ctx.font = "bold 32px Arial";
        ctx.textAlign = "center";
        ctx.fillText("燃料过磅单结算凭证", canvas.width / 2, 50);
        ctx.textAlign = "left";
        ctx.font = "24px Arial";
        const startX = 50;
        let startY = 120;
        const lineHeight = 40;
        const drawRow = (label, value) => {
            ctx.fillText(label, startX, startY);
            ctx.fillText(value, startX + 200, startY);
            startY += lineHeight;
        };
        drawRow("日期:", r.date);
        drawRow("供应商:", r.supplier);
        drawRow("车牌号:", r.plateNumber);
        drawRow("燃料种类:", r.fuelType);
        drawRow("扣后重量:", r.finalWeight + " 吨");
        drawRow("货款价格:", r.userPrice + " 元/吨");
        startY += 20;
        ctx.beginPath();
        ctx.moveTo(startX, startY);
        ctx.lineTo(canvas.width - 50, startY);
        ctx.strokeStyle = "#cccccc";
        ctx.stroke();
        startY += 50;
        ctx.font = "italic 20px Arial";
        ctx.fillStyle = "#555555";
        let formulaText = `计算公式：付款总额 = 扣后重量 (${r.finalWeight}) × 货款价格 (${r.userPrice})`;
        if (r.isZhengBoss) {
            formulaText += ` - 运费 (${r.freight})`;
            drawRow("运费:", r.freight + " 元");
        }
        ctx.fillText(formulaText, startX, startY);
        startY += 60;
        ctx.font = "bold 36px Arial";
        ctx.fillStyle = "#0000ff";
        ctx.fillText("付款总额：" + r.totalPayment + " 元", startX, startY);
        ctx.font = "16px Arial";
        ctx.fillStyle = "#999999";
        ctx.textAlign = "right";
        ctx.fillText("生成时间：" + new Date().toLocaleString(), canvas.width - 50, canvas.height - 30);
        try {
            const link = document.createElement('a');
            link.download = `结算单_${r.date}_${r.plateNumber}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
            showToast("图片已生成，请查看下载");
        } catch (e) {
            showToast("导出失败，请截图保存");
        }
    }
</script>
</body>
</html>
